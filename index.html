<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-big-counter.min.css?v=1.0.2">















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"hide","offset":12,"onmobile":false,"dimmer":true},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Notes of study, work and life">
<meta property="og:type" content="website">
<meta property="og:title" content="Anda">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Anda">
<meta property="og:description" content="Notes of study, work and life">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Anda">
<meta name="twitter:description" content="Notes of study, work and life">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Anda</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Anda</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Notes of study, work and life</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">19</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">2</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">22</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/Luorinz" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/29/GAE Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/29/GAE Basic/" class="post-title-link" itemprop="url">GAE Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-29 18:05:54 / Modified: 11:08:46" itemprop="dateCreated datePublished" datetime="2019-04-29T18:05:54-07:00">2019-04-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">9.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">9 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Google-Cloud-Platform"><a href="#Google-Cloud-Platform" class="headerlink" title="Google Cloud Platform"></a>Google Cloud Platform</h1><h2 id="GAE-Google-App-Engine"><a href="#GAE-Google-App-Engine" class="headerlink" title="GAE (Google App Engine)"></a>GAE (Google App Engine)</h2><p><code>Google App Engine</code> is a cloud computing platform for developing and hosting web applications in Google-managed data centers.</p>
<h2 id="GCE-Google-Compute-Engine"><a href="#GCE-Google-Compute-Engine" class="headerlink" title="GCE (Google Compute Engine)"></a>GCE (Google Compute Engine)</h2><p><code>Google Compute Engine</code> delivers virtual machines running in Google’s innovative data centers and worldwide fiber network.</p>
<h2 id="GKE-Google-Container-Engine"><a href="#GKE-Google-Container-Engine" class="headerlink" title="GKE (Google Container Engine)"></a>GKE (Google Container Engine)</h2><p><a href="https://cloud.google.com/containers/" target="_blank" rel="noopener">https://cloud.google.com/containers/</a></p>
<h2 id="Dataflow"><a href="#Dataflow" class="headerlink" title="Dataflow"></a>Dataflow</h2><p><code>Dataflow</code> is a unified programming model and a managed service for developing and executing a wide range of data processing patterns including ETL, batch computation, and continuous computation.</p>
<h2 id="BigTable"><a href="#BigTable" class="headerlink" title="BigTable"></a>BigTable</h2><p><code>Cloud Bigtable</code> is Google’s NoSQL Big Data database service. It’s the same database that powers many core Google services, including Search, Analytics, Maps, and Gmail.</p>
<h2 id="BigQuery"><a href="#BigQuery" class="headerlink" title="BigQuery"></a>BigQuery</h2><p><code>BigQuery</code> is Google’s fully managed, petabyte scale, low cost enterprise data warehouse for analytics.</p>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><ul>
<li>PubSub</li>
<li>Datastore</li>
<li>Storage</li>
<li>Monitoring </li>
</ul>
<h1 id="What-is-a-typical-BigData-project-web-analysis"><a href="#What-is-a-typical-BigData-project-web-analysis" class="headerlink" title="What is a typical BigData project (web+analysis)"></a>What is a typical BigData project (web+analysis)</h1><p><img src="https://raw.githubusercontent.com/Luorinz/images/master/3.%20GAE%20Basic-2019-4-28-21-11-47.png" alt="3. GAE Basic-2019-4-28-21-11-47.png"></p>
<ul>
<li>Service (GAE/GKE) to receive user generated contents</li>
<li>Datastore (BigTable/Spanner) to save contents</li>
<li>Index (ElasticSearch) to query contents in runtime</li>
<li>Service (GAE/GKE) to serve contents in runtime</li>
<li>Dataflow (MapReduce) to dump data into BigQuery</li>
<li>BigQuery (SQL) to perform further analysis</li>
</ul>
<blockquote>
<p>GKE is more like a simple GCE</p>
</blockquote>
<h1 id="Google-App-Engine-Flex"><a href="#Google-App-Engine-Flex" class="headerlink" title="Google App Engine Flex"></a>Google App Engine Flex</h1><p><code>App Engine flexible environment</code> automatically scales your app up and down while balancing the load. Microservices, authorization, SQL and NoSQL databases, traffic splitting, logging. </p>
<p>Step 3.1.1 In your Intellij, create a new file called <code>app.yaml</code></p>
<p>The content has just two lines.</p>
<blockquote>
<p>GAE 通过flex实现负载均衡</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">runtime:</span> <span class="string">go</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">flex</span></span><br></pre></td></tr></table></figure>
<p><strong>Recommended</strong>: upload your two files (main.go and app.yaml) into github. </p>
<p>Worst cast: just copy and paste in terminals.</p>
<p>More readings</p>
<ul>
<li>Overview <a href="https://cloud.google.com/docs/overview/" target="_blank" rel="noopener">https://cloud.google.com/docs/overview/</a> </li>
<li>Flex in GAE <a href="https://cloud.google.com/appengine/docs/flexible/" target="_blank" rel="noopener">https://cloud.google.com/appengine/docs/flexible/</a> </li>
<li>GAE on Golang <a href="https://cloud.google.com/appengine/docs/go/" target="_blank" rel="noopener">https://cloud.google.com/appengine/docs/go/</a> </li>
<li>GAE in go: <a href="https://cloud.google.com/appengine/docs/flexible/go/quickstart" target="_blank" rel="noopener">https://cloud.google.com/appengine/docs/flexible/go/quickstart</a> </li>
</ul>
<h1 id="Setup-cloud-terminal"><a href="#Setup-cloud-terminal" class="headerlink" title="Setup cloud terminal."></a>Setup cloud terminal.</h1><p>Question: Why use cloud terminal?<br>Answer: Such that we do not rely on the local environment (Windows vs. Mac). </p>
<h2 id="Click-‘Activate-Google-Cloud-Shell’-Wait-until-the-init-is-done"><a href="#Click-‘Activate-Google-Cloud-Shell’-Wait-until-the-init-is-done" class="headerlink" title="Click ‘Activate Google Cloud Shell’.  Wait until the init is done"></a>Click ‘Activate Google Cloud Shell’.  Wait until the init is done</h2><p>Then you will see a vm available for you to play. This is similar to the EC2 vm.</p>
<h2 id="Install-go-libraries-in-gcloud-terminal"><a href="#Install-go-libraries-in-gcloud-terminal" class="headerlink" title="Install go libraries in gcloud terminal."></a>Install go libraries in gcloud terminal.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get gopkg.in/olivere/elastic.v3</span><br><span class="line">go get github.com/pborman/uuid</span><br></pre></td></tr></table></figure>
<h2 id="Recommended-Checkout-your-codes-from-github"><a href="#Recommended-Checkout-your-codes-from-github" class="headerlink" title="(Recommended) Checkout your codes from github"></a>(Recommended) Checkout your codes from github</h2><p>git clone <a href="https://github.com/Luorinz/Around.git" target="_blank" rel="noopener">https://github.com/Luorinz/Around.git</a></p>
<p><strong>Question</strong>: what’s the purpose of app.yaml?</p>
<p><strong>Answer</strong>: to tell google that your program is a go program and use go compiler to run it.</p>
<p>Then enter this line of code to make sure you copy past is done.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat main.go | head -n 5</span><br></pre></td></tr></table></figure>
<p>You’re expected to see this<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">        elastic &quot;gopkg.in/olivere/elastic.v3&quot;</span><br><span class="line">        &quot;fmt&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="Enter-gcloud-app-deploy"><a href="#Enter-gcloud-app-deploy" class="headerlink" title="Enter gcloud app deploy"></a>Enter <code>gcloud app deploy</code></h2><p>When asked about site, enter 1, which is <code>us-west2</code></p>
<p>When asked Y/n, enter Y. The deployment may take more than 10 minutes to finish (next deployment will be faster).</p>
<p>Error: If you have error like this, you may have a wrong ES_URL. Update the value and deploy again.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Updating service [default]...failed.                                                                                         </span><br><span class="line">ERROR: (gcloud.app.deploy) Error Response: [9] </span><br><span class="line">Application startup error:</span><br><span class="line">+ exec app</span><br><span class="line">panic: no Elasticsearch node available</span><br></pre></td></tr></table></figure>
<h2 id="Open-Postman-find-the-post-query-from-history"><a href="#Open-Postman-find-the-post-query-from-history" class="headerlink" title="Open Postman, find the post query from history."></a>Open Postman, find the post query from history.</h2><p><code>(POST, url=http://xxx.appspot.com/post)</code></p>
<p>Replace xxx with your real project id</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"user"</span>:<span class="string">"1111"</span>,</span><br><span class="line">	<span class="attr">"message"</span>:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">	<span class="attr">"location"</span>:&#123;</span><br><span class="line">		<span class="attr">"lat"</span>:<span class="number">37.5</span>,</span><br><span class="line">		<span class="attr">"lon"</span>:<span class="number">-120.1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And then find the get query from history. (GET, url=<a href="http://around-xxxx.appspot.com/search?lat=37.5&amp;lon=-120" target="_blank" rel="noopener">http://around-xxxx.appspot.com/search?lat=37.5&amp;lon=-120</a>)<br>You should get the results back</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"user"</span>: <span class="string">"1111"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">        <span class="attr">"location"</span>: &#123;</span><br><span class="line">            <span class="attr">"lat"</span>: <span class="number">37.5</span>,</span><br><span class="line">            <span class="attr">"lon"</span>: <span class="number">-120.1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Play with more examples. If you do not have any results back, try to change your lat or lon to make sure it’s within 200km.</p>
<h2 id="Check-the-logging-to-see-if-there-is-any-error-message"><a href="#Check-the-logging-to-see-if-there-is-any-error-message" class="headerlink" title="Check the logging to see if there is any error message"></a>Check the logging to see if there is any error message</h2><p>Choose SATCKDRIVER -&gt; Logging -&gt; Logs</p>
<h2 id="Optional-Stop-Instance-to-save-credit"><a href="#Optional-Stop-Instance-to-save-credit" class="headerlink" title="(Optional) Stop Instance to save credit."></a>(Optional) Stop Instance to save credit.</h2><h2 id="Optional-Start-the-instance-again-In-the-same-page-choose-one-instance-and-click-START-If-the-START-is-disabled-refresh-it-or-wait-a-minute"><a href="#Optional-Start-the-instance-again-In-the-same-page-choose-one-instance-and-click-START-If-the-START-is-disabled-refresh-it-or-wait-a-minute" class="headerlink" title="(Optional) Start the instance again. In the same page, choose one instance and click START. If the START is disabled, refresh it or wait a minute."></a>(Optional) Start the instance again. In the same page, choose one instance and click START. If the START is disabled, refresh it or wait a minute.</h2><h2 id="Optional-How-to-filter-word"><a href="#Optional-How-to-filter-word" class="headerlink" title="(Optional) How to filter word"></a>(Optional) How to filter word</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">containsFilteredWords</span><span class="params">(s *<span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">        filteredWords := []<span class="keyword">string</span>&#123;</span><br><span class="line">                <span class="string">"fuck"</span>,</span><br><span class="line">                <span class="string">"100"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> _, word := <span class="keyword">range</span> filteredWords &#123;</span><br><span class="line">                <span class="keyword">if</span> strings.Contains(*s, word) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Update relevant part from your code</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, item := <span class="keyword">range</span> searchResult.Each(reflect.TypeOf(typ)) &#123;</span><br><span class="line">                p := item.(Post)</span><br><span class="line">                fmt.Printf(<span class="string">"Post by %s: %s at lat %v and lon %v\n"</span>, p.User, p.Message, p.Location.Lat, p.Location.Lon)</span><br><span class="line">                <span class="comment">// TODO(vincent): Perform filtering based on keywords such as web spam etc.</span></span><br><span class="line">                <span class="keyword">if</span> !containsFilteredWords(&amp;p.Message) &#123;</span><br><span class="line">                        ps = <span class="built_in">append</span>(ps, p)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Related string operations<br><code>https://golang.org/pkg/strings/</code></p>
<h2 id="Optional-Useful-Go-information"><a href="#Optional-Useful-Go-information" class="headerlink" title="(Optional) Useful Go information"></a>(Optional) Useful Go information</h2><h3 id="Error-vs-Panic"><a href="#Error-vs-Panic" class="headerlink" title="Error vs Panic"></a>Error vs Panic</h3><ul>
<li>Error: normal way to handle error status.</li>
<li><p>Panic: normally used when some “impossible” situation happens with no intend recover.</p>
<ul>
<li>Use “recover” to handle when exiting function.</li>
<li>recover is like catch</li>
</ul>
</li>
</ul>
<h3 id="“defer”-clause"><a href="#“defer”-clause" class="headerlink" title="“defer” clause"></a>“defer” clause</h3><ul>
<li>Preferred way to recycle resources<ul>
<li>E.g. file handles, network connections, etc.</li>
<li>Defer executes after return</li>
<li>First come last executes</li>
<li>Example</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> f File</span><br><span class="line">        <span class="keyword">if</span> f, err = os.Open(“Somefile”); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(“Error open file”)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// some other error happens</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span>  &#123;</span><br><span class="line">                <span class="built_in">panic</span>(“Unexpected error”)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Combined with recover to handle panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">()</span> <span class="title">result</span> <span class="title">string</span>, <span class="title">err</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">type</span> openFileError <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">        <span class="keyword">type</span> unexpectedError <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> p := <span class="built_in">recover</span>(); p &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">                        <span class="comment">// no panic</span></span><br><span class="line">                <span class="keyword">case</span> openFileError&#123;&#125;:</span><br><span class="line">                        err = fmt.Errorf(“Open file error”)</span><br><span class="line">                <span class="keyword">case</span> unexpectedError&#123;&#125;:</span><br><span class="line">                        err = fmt.Errorf(“Unexpected error”)</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                        <span class="built_in">panic</span>(p)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> f File</span><br><span class="line">        <span class="keyword">if</span> f, err = os.Open(“Somefile”); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(openFileError&#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Some work...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Some other error happens</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span>  &#123;</span><br><span class="line">                <span class="built_in">panic</span>(unexpectedError&#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Go’s multiprocessing facility: Communication Sequential Processes<ul>
<li><a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Communicating_sequential_processes</a></li>
<li>Lightweight concurrency, synchronize using message passing</li>
</ul>
</li>
<li>Go routine<ul>
<li>Go’s concurrency mechanism</li>
<li>Lightweight (corresponding to fiber)<ul>
<li>Growable stacks</li>
<li>Scheduling<ul>
<li>m:n scheduling - m goroutine on n OS threads</li>
<li>Scheduler invoked implicitly by language construct<ul>
<li>E.g. time.Sleep, I/O, etc.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Have no identity - nothing like thread id<ul>
<li>Avoid thread-local storage (TLS, tend to be misused, similar to global variable)</li>
<li>Easy go routine migration</li>
</ul>
</li>
<li>Example</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clock.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"io"</span></span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"net"</span></span><br><span class="line">        <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConn</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> c.Close()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">                _, err := io.WriteString(c, time.Now().Format(<span class="string">"15:04:05\n"</span>))</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="comment">// e.g., client disconnected</span></span><br><span class="line">                &#125;</span><br><span class="line">                time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">                conn, err := listener.Accept()</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        log.Print(err) <span class="comment">// e.g., connection aborted</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                handleConn(conn)</span><br><span class="line">                <span class="comment">//go handleConn(conn) // handle connections concurrently</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// netcat.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"io"</span></span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"net"</span></span><br><span class="line">        <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> conn.Close()</span><br><span class="line">        mustCopy(os.Stdout, conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mustCopy</span><span class="params">(dst io.Writer, src io.Reader)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> _, err := io.Copy(dst, src); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Go channel<ul>
<li>Communication mechanism for Go routine</li>
<li>Example</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel_example.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        messages := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">                        fmt.Println(i)</span><br><span class="line">                &#125;</span><br><span class="line">                messages &lt;- <span class="string">"done"</span></span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        msg := &lt;-messages</span><br><span class="line"></span><br><span class="line">        fmt.Println(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>More reading<ul>
<li><a href="https://golang.org/doc/" target="_blank" rel="noopener">https://golang.org/doc/</a></li>
<li>The Go Programming Language - <a href="http://www.gopl.io/" target="_blank" rel="noopener">http://www.gopl.io/</a></li>
<li><a href="https://blog.golang.org/" target="_blank" rel="noopener">https://blog.golang.org/</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/29/ElasticSearch and GCE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/29/ElasticSearch and GCE/" class="post-title-link" itemprop="url">ElasticSearch and GCE</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-29 02:41:05" itemprop="dateCreated datePublished" datetime="2019-04-29T02:41:05-07:00">2019-04-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-28 19:42:36" itemprop="dateModified" datetime="2019-04-28T19:42:36-07:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">15k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">14 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Introduction-to-Around"><a href="#Introduction-to-Around" class="headerlink" title="Introduction to Around"></a>Introduction to Around</h1><p>Demo: <a href="http://recordit.co/awrQb1zn2I" target="_blank" rel="noopener">http://recordit.co/awrQb1zn2I</a></p>
<p><code>Around</code>: a Geo-index based social network</p>
<p>•    Built a scalable web service in Go to handle posts and deployed to Google Cloud (GAE flex) for better scaling</p>
<p>•    Utilized ElasticSearch (GCE) to provide geo-location based search functions such that users can search nearby posts within a distance (e.g. 200km)</p>
<p>•    Used Google Dataflow to implement a daily dump of posts to BigQuery table for offline analysis</p>
<p>•    Aggregated the data at the post level and user level to improve the keyword based spam detection (BigQuery)</p>
<h1 id="Create-a-new-cloud-project"><a href="#Create-a-new-cloud-project" class="headerlink" title="Create a new cloud project."></a>Create a new cloud project.</h1><p>Step 2.1.1 Open <a href="https://console.cloud.google.com/" target="_blank" rel="noopener">https://console.cloud.google.com/</a> and sign in with your gmail account. </p>
<p>Choose Sign up for free trial, enter a credit card (Must do). GCP has $300 discount for new users, which is enough for project purpose. </p>
<p>Step 2.1.2 Click ‘My Project’. Create a new Project called ‘Around’. Google Cloud will automatically generate a new project id for you. </p>
<h1 id="Geo-Index-and-ElasticSearch"><a href="#Geo-Index-and-ElasticSearch" class="headerlink" title="Geo-Index and ElasticSearch"></a>Geo-Index and ElasticSearch</h1><p>how to perform 1-d range search? For example, given a 1-d binary search tree, find all the values between [3, 18].<br><img src="https://raw.githubusercontent.com/Luorinz/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-47-57.png" alt="ElasticSearch and GCE-2019-4-28-14-47-57.png"></p>
<p>What about 2d data? </p>
<ul>
<li>Geo index: lat between [10.2, 10.3] and lon between [120.0, 120.5]</li>
<li>Price between [$10, $100], date between [Jan-01-2017, Jun-01-2017]</li>
<li>Weight between [120pb,140pb], height between [150cm, 180cm]</li>
<li>…</li>
</ul>
<p>K-D tree is one implementation to solve such k-dimensional search problem. </p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-11.png" alt="ElasticSearch and GCE-2019-4-28-14-48-11.png"></p>
<p>Then we choose one median point and split the space into two parts horizontally. </p>
<p> <img src="https://raw.githubusercontent.com/Luorinz/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-18.png" alt="ElasticSearch and GCE-2019-4-28-14-48-18.png"></p>
<p>Continue to split them into more parts (vertically)</p>
<p> <img src="https://raw.githubusercontent.com/Luorinz/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-25.png" alt="ElasticSearch and GCE-2019-4-28-14-48-25.png"></p>
<p>Question: how to find all the points within a Range (R)?</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-32.png" alt="ElasticSearch and GCE-2019-4-28-14-48-32.png"></p>
<p>Range Search Algorithm:</p>
<ul>
<li>If query box doesn’t overlap bounding box, stop recursion </li>
<li>If bounding box is a subset of query box, report all the points in current subtree</li>
<li>If bounding box overlaps query box, recurse left and right</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-40.png" alt="ElasticSearch and GCE-2019-4-28-14-48-40.png"></p>
<h2 id="ELK-ElasticSearch-Logstash-and-Kibana"><a href="#ELK-ElasticSearch-Logstash-and-Kibana" class="headerlink" title="ELK (ElasticSearch, Logstash and Kibana)"></a>ELK (ElasticSearch, Logstash and Kibana)</h2><p><code>Elasticsearch</code> is an open source, distributed, RESTful search engine. As the heart of the Elastic Stack, it centrally stores your data so you can query the data quickly.</p>
<blockquote>
<p>SQL is slower. Since ELK uses a pair to search directly.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> LOCATIONS <span class="keyword">WHERE</span> lat &lt;= <span class="number">12</span> <span class="keyword">AND</span> lat &gt;= <span class="number">10</span> <span class="keyword">AND</span> lon &gt;= <span class="number">120</span> <span class="keyword">AND</span> lon &lt;= <span class="number">130</span></span><br></pre></td></tr></table></figure>
<h1 id="Google-Compute-Engine-GCE"><a href="#Google-Compute-Engine-GCE" class="headerlink" title="Google Compute Engine (GCE)"></a>Google Compute Engine (GCE)</h1><h2 id="Cloud-Model"><a href="#Cloud-Model" class="headerlink" title="Cloud Model"></a>Cloud Model</h2><ul>
<li>IaaS (Infrastructure as a service)</li>
</ul>
<p>Offers virtual machines (Xen, KVM, VirtualBox, VMware ESX, etc.). Amazon EC2 and Google Compute Engine belong to IaaS as well. </p>
<ul>
<li>PaaS (Platform as a service)</li>
</ul>
<p>computing platform including programming language execution environment, database and web server. Develop and run their software solutions on a cloud platform without the cost and complexity of buying and managing hardware and software layers Microsoft Azure, Google App Engine</p>
<ul>
<li>SaaS (Software as a service)</li>
</ul>
<p>users are provided access to application software and databases.<br>Google Apps, GoToMeeting</p>
<p>The overall structure (tech stack) of our project:</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/1.%20Go%20and%20Web%20Service-2019-4-27-13-55-46.png" alt="1. Go and Web Service-2019-4-27-13-55-46.png"></p>
<p><strong>Question</strong>: why we need such a complicated infrastructure</p>
<p><strong>Answer</strong>: because in industry, we need to handle very different requirements compared to in school. </p>
<h2 id="Configure"><a href="#Configure" class="headerlink" title="Configure"></a>Configure</h2><h3 id="Find-NETWORKING-gt-VPC-network-gt-Firewall-rules"><a href="#Find-NETWORKING-gt-VPC-network-gt-Firewall-rules" class="headerlink" title="Find NETWORKING -&gt; VPC network -&gt; Firewall rules"></a>Find NETWORKING -&gt; VPC network -&gt; Firewall rules</h3><p>Click <code>CREATE FIREWALL RULE</code></p>
<p>In the next page, give it a name like <code>‘elasticsearch’</code>. Set the Target tags to be <code>‘es’</code>, source IP ranges to be <code>‘0.0.0.0/0’</code>, and the specified protocols and ports to be <code>‘tcp:9200’</code>. </p>
<p>Wait until the firewall rules is created. </p>
<h3 id="Find-Compute-Engine-gt-VM-instances"><a href="#Find-Compute-Engine-gt-VM-instances" class="headerlink" title="Find Compute Engine-&gt;VM instances"></a>Find Compute Engine-&gt;VM instances</h3><p>Choose ‘Change’ and switch to Ubuntu 16. Keep the size of 10GB is fine. </p>
<p>Then in the Networking -&gt; Network tags, set it to be <code>‘es’</code> (the firewall rule that we created). </p>
<h3 id="After-one-minute-you-will-see-the-instance-is-started-Choose-‘SSH’-and-then-‘Open-in-browser-window’"><a href="#After-one-minute-you-will-see-the-instance-is-started-Choose-‘SSH’-and-then-‘Open-in-browser-window’" class="headerlink" title="After one minute, you will see the instance is started. Choose ‘SSH’ and then ‘Open in browser window’."></a>After one minute, you will see the instance is started. Choose <code>‘SSH’</code> and then ‘Open in browser window’.</h3><h3 id="In-the-terminal-enter"><a href="#In-the-terminal-enter" class="headerlink" title="In the terminal, enter"></a>In the terminal, enter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install default-jre</span><br></pre></td></tr></table></figure>
<p>It will install java to your vm. To verify, enter <code>‘which java’</code> and <code>‘java -version’</code> to check</p>
<p>Install ElasticSearch as below </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.3.1/elasticsearch-2.3.1.deb</span><br><span class="line">sudo dpkg -i elasticsearch-2.3.1.deb</span><br><span class="line">sudo systemctl enable elasticsearch.service</span><br></pre></td></tr></table></figure>
<p>Edit the configuration file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/elasticsearch/elasticsearch.yml</span><br></pre></td></tr></table></figure>
<p>Add two lines to the config, to allow all traffic and listen on port 9200.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></table></figure>
<p>Save this and Start ElasticSearch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service elasticsearch start</span><br></pre></td></tr></table></figure>
<p>Check the status of ElasticSearch<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service elasticsearch status</span><br></pre></td></tr></table></figure></p>
<p>You should be able to see ‘active’ in the status</p>
<p>Back to your console.cloud.google.com, find the public IP address(external)</p>
<p>Put the IP address and port together (:9200) in a new tab and see whether the server is on. The name or version might be different.</p>
<blockquote>
<p>NOTE: Don’t use https! Should use http.</p>
</blockquote>
<p>You should get something like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"Honey Lemon"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"2.3.1"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"bd980929010aef404e7cb0843e61d0665269fc39"</span>,</span><br><span class="line">    <span class="attr">"build_timestamp"</span> : <span class="string">"2016-04-04T12:25:05Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"5.5.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Which means your ES server is running as expected. </p>
<h2 id="Update-Go-Code"><a href="#Update-Go-Code" class="headerlink" title="Update Go Code"></a>Update Go Code</h2><h3 id="Update-handlerSearch"><a href="#Update-handlerSearch" class="headerlink" title="Update handlerSearch"></a>Update handlerSearch</h3><p>Original source of codes (<a href="https://olivere.github.io/elastic/" target="_blank" rel="noopener">https://olivere.github.io/elastic/</a>)  </p>
<blockquote>
<p>In here we have to import source code of elastic.(v3)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">To get the package, execute:</span><br><span class="line"></span><br><span class="line">go get gopkg.in/olivere/elastic.v3</span><br><span class="line"></span><br><span class="line">To import this package, add the following line to your code:</span><br><span class="line"></span><br><span class="line">import &quot;gopkg.in/olivere/elastic.v3&quot;</span><br><span class="line"></span><br><span class="line">Refer to it as elastic.</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one request for search"</span>)</span><br><span class="line">      lat, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lat"</span>), <span class="number">64</span>)</span><br><span class="line">      lon, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lon"</span>), <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// range is optional </span></span><br><span class="line">      ran := DISTANCE </span><br><span class="line">      <span class="keyword">if</span> val := r.URL.Query().Get(<span class="string">"range"</span>); val != <span class="string">""</span> &#123; </span><br><span class="line">         ran = val + <span class="string">"km"</span> </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     fmt.Printf( <span class="string">"Search received: %f %f %s\n"</span>, lat, lon, ran)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Create a client</span></span><br><span class="line">      client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Define geo distance query as specified in</span></span><br><span class="line">      <span class="comment">// https://www.elastic.co/guide/en/elasticsearch/reference/5.2/query-dsl-geo-distance-query.html</span></span><br><span class="line">      q := elastic.NewGeoDistanceQuery(<span class="string">"location"</span>)</span><br><span class="line">      q = q.Distance(ran).Lat(lat).Lon(lon)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Some delay may range from seconds to minutes. So if you don't get enough results. Try it later.</span></span><br><span class="line">      searchResult, err := client.Search().</span><br><span class="line">             Index(INDEX).</span><br><span class="line">             Query(q).</span><br><span class="line">             Pretty(<span class="literal">true</span>).</span><br><span class="line">             Do()</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="comment">// Handle error</span></span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// searchResult is of type SearchResult and returns hits, suggestions,</span></span><br><span class="line">      <span class="comment">// and all kinds of other information from Elasticsearch.</span></span><br><span class="line">      fmt.Printf(<span class="string">"Query took %d milliseconds\n"</span>, searchResult.TookInMillis)</span><br><span class="line">      <span class="comment">// TotalHits is another convenience function that works even when something goes wrong.</span></span><br><span class="line">      fmt.Printf(<span class="string">"Found a total of %d post\n"</span>, searchResult.TotalHits())</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Each is a convenience function that iterates over hits in a search result.</span></span><br><span class="line">      <span class="comment">// It makes sure you don't need to check for nil values in the response.</span></span><br><span class="line">      <span class="comment">// However, it ignores errors in serialization.</span></span><br><span class="line">      <span class="keyword">var</span> typ Post</span><br><span class="line">      <span class="keyword">var</span> ps []Post</span><br><span class="line">      <span class="keyword">for</span> _, item := <span class="keyword">range</span> searchResult.Each(reflect.TypeOf(typ)) &#123; <span class="comment">// instance of</span></span><br><span class="line">             p := item.(Post) <span class="comment">// p = (Post) item</span></span><br><span class="line">             fmt.Printf(<span class="string">"Post by %s: %s at lat %v and lon %v\n"</span>, p.User, p.Message, p.Location.Lat, p.Location.Lon)</span><br><span class="line">             <span class="comment">// TODO(student homework): Perform filtering based on keywords such as web spam etc.</span></span><br><span class="line">             ps = <span class="built_in">append</span>(ps, p)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      js, err := json.Marshal(ps)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">      w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">      w.Write(js)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Code-explanation"><a href="#Code-explanation" class="headerlink" title="Code explanation"></a>Code explanation</h2><p>Let’s explain these codes line by line<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br></pre></td></tr></table></figure></p>
<p>It means we create a connection to ES. If there is err, return. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q := elastic.NewGeoDistanceQuery(<span class="string">"location"</span>)</span><br></pre></td></tr></table></figure>
<p>Prepare a geo based query to find posts within a geo box.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">searchResult, err := client.Search().</span><br><span class="line">             Index(INDEX).</span><br><span class="line">             Query(q).</span><br><span class="line">             Pretty(<span class="literal">true</span>).</span><br><span class="line">             Do()</span><br></pre></td></tr></table></figure>
<p>Get the results based on <code>Index</code> (similar to <code>dataset</code>) and <code>query</code> (<code>q</code> that we just prepared). <code>Pretty</code> means to format the output. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> searchResult.Each(reflect.TypeOf(typ)) &#123;</span><br></pre></td></tr></table></figure>
<p>Iterate the result in results which are type of Post (typ)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p := item.(Post)</span><br></pre></td></tr></table></figure>
<p>Cast an item to Post, equals to <code>p = (Post) item</code>  in java</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps = <span class="built_in">append</span>(ps, p)</span><br></pre></td></tr></table></figure>
<p>Add the p to an array, equals <code>ps.add(p)</code> in java</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">js, err := json.Marshal(ps)</span><br></pre></td></tr></table></figure>
<p>Convert the go object(array) to a string<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br></pre></td></tr></table></figure></p>
<p>Allow cross domain visit for javascript.</p>
<p>We also need to put ES library in import<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      elastic <span class="string">"gopkg.in/olivere/elastic.v3"</span></span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"log"</span></span><br><span class="line">      <span class="string">"strconv"</span></span><br><span class="line">      <span class="string">"reflect"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>Add const before main function</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">      INDEX = <span class="string">"around"</span></span><br><span class="line">      TYPE = <span class="string">"post"</span></span><br><span class="line">      DISTANCE = <span class="string">"200km"</span></span><br><span class="line">      <span class="comment">// Needs to update</span></span><br><span class="line">      <span class="comment">//PROJECT_ID = "around-xxx"</span></span><br><span class="line">      <span class="comment">//BT_INSTANCE = "around-post"</span></span><br><span class="line">      <span class="comment">// Needs to update this URL if you deploy it to cloud.</span></span><br><span class="line">      ES_URL = <span class="string">"http://YOUR_ES_IP_ADDRESS:9200"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">      http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">      http.HandleFunc(<span class="string">"/search"</span>, handlerSearch)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Replace <code>YOUR_ES_IP_ADDRESS</code> with your ES address (public IP).</p>
<blockquote>
<p><a href="http://externalIp:9200" target="_blank" rel="noopener">http://externalIp:9200</a></p>
</blockquote>
<p>Step 2.2.5 Open your terminal (Mac and Windows). Enter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get  gopkg.in/olivere/elastic.v3</span><br></pre></td></tr></table></figure>
<p>Once it is done, you won’t be able to see any more compile errors in Intellij. If it does not work (elastic is still red), try to restart it. </p>
<p>More readings</p>
<ul>
<li>Reflect type <a href="https://golang.org/pkg/reflect/" target="_blank" rel="noopener">https://golang.org/pkg/reflect/</a> </li>
<li>ES in Go <a href="https://github.com/olivere/elastic" target="_blank" rel="noopener">https://github.com/olivere/elastic</a> </li>
</ul>
<p>Step 2.2.6 In order to create index in ES, we need to update main</p>
<p><strong>What’s mapping in ES?</strong> It tells you what’s the type of a variable if not default.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create a client</span></span><br><span class="line">	client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use the IndexExists service to check if a specified index exists.</span></span><br><span class="line">	exists, err := client.IndexExists(INDEX).Do()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !exists &#123;</span><br><span class="line">		<span class="comment">// Create a new index.</span></span><br><span class="line">		mapping := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">			"mappings":&#123;</span></span><br><span class="line"><span class="string">				"post":&#123;</span></span><br><span class="line"><span class="string">					"properties":&#123;</span></span><br><span class="line"><span class="string">						"location":&#123;</span></span><br><span class="line"><span class="string">							"type":"geo_point"</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;`</span></span><br><span class="line">		_, err := client.CreateIndex(INDEX).Body(mapping).Do()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// Handle error</span></span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">	http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">	http.HandleFunc(<span class="string">"/search"</span>, handlerSearch)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists, err := client.IndexExists(INDEX).Do()</span><br></pre></td></tr></table></figure>
<p>Check if the index exists. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mapping := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">                    "mappings":&#123;</span></span><br><span class="line"><span class="string">                           "post":&#123;</span></span><br><span class="line"><span class="string">                                  "properties":&#123;</span></span><br><span class="line"><span class="string">                                         "location":&#123;</span></span><br><span class="line"><span class="string">                                                "type":"geo_point"</span></span><br><span class="line"><span class="string">                                         &#125;</span></span><br><span class="line"><span class="string">                                  &#125;</span></span><br><span class="line"><span class="string">                           &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br></pre></td></tr></table></figure>
<p>If not, create a new mapping. For other fields (user, message, etc.) no need to have mapping as they are default. For geo location (lat, lon), we need to tell ES that they are geo points instead of two float points such that ES will use Geo-indexing for them (K-D tree)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_, err := client.CreateIndex(INDEX).Body(mapping).Do()</span><br></pre></td></tr></table></figure>
<p>Create this index</p>
<p>More readings</p>
<ul>
<li>ES in Go <a href="https://github.com/olivere/elastic" target="_blank" rel="noopener">https://github.com/olivere/elastic</a> </li>
<li>Mapping in ES <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html</a> </li>
</ul>
<p>Step 2.2.7 Update handlerPost</p>
<p>Add external import of uuid</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      elastic <span class="string">"gopkg.in/olivere/elastic.v3"</span></span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"log"</span></span><br><span class="line">      <span class="string">"strconv"</span></span><br><span class="line">      <span class="string">"reflect"</span></span><br><span class="line">      <span class="string">"github.com/pborman/uuid"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>How to add a new document to the index?</p>
<p><a href="https://github.com/olivere/elastic" target="_blank" rel="noopener">https://github.com/olivere/elastic</a> has an example</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add a document to the index</span></span><br><span class="line"><span class="comment">// Refresh(true) means if duplicate appears, overwrite it</span></span><br><span class="line">tweet := Tweet&#123;User: <span class="string">"olivere"</span>, Message: <span class="string">"Take Five"</span>&#125;</span><br><span class="line">_, err = client.Index().</span><br><span class="line">    Index(<span class="string">"twitter"</span>).</span><br><span class="line">    Type(<span class="string">"tweet"</span>).</span><br><span class="line">    Id(<span class="string">"1"</span>).</span><br><span class="line">    BodyJson(tweet).</span><br><span class="line">    Refresh(<span class="literal">true</span>).</span><br><span class="line">    Do(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// Handle error</span></span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Student Question: how to complete this one?</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerPost</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      <span class="comment">// Parse from body of request to get a json object.</span></span><br><span class="line">      fmt.Println(<span class="string">"Received one post request"</span>)</span><br><span class="line">      decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> p Post</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      id := uuid.New()</span><br><span class="line">      <span class="comment">// Save to ES.</span></span><br><span class="line">      saveToES(&amp;p, id)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save a post to ElasticSearch</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveToES</span><span class="params">(p *Post, id <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create a client</span></span><br><span class="line">	es_client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save it to index</span></span><br><span class="line">	_, err = es_client.Index().</span><br><span class="line">		Index(INDEX).</span><br><span class="line">		Type(TYPE).</span><br><span class="line">		Id(id).</span><br><span class="line">		BodyJson(p).</span><br><span class="line">		Refresh(<span class="literal">true</span>).</span><br><span class="line">		Do()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"Post is saved to Index: %s\n"</span>, p.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 2.2.8 Open terminal, enter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/pborman/uuid</span><br></pre></td></tr></table></figure>
<p>Make sure your ES_URL is updated from your aws instance in step 1.</p>
<p>Step 2.2.9 Run your main.go again</p>
<h2 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h2><p>If you have such an error, your ES_URL is incorrect.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panic: no Elasticsearch node available</span><br></pre></td></tr></table></figure>
<p>If you have such error, you have started two <code>main.go</code>, stop the other one.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017/06/30 07:07:01 listen tcp :8080: bind: Only one usage of each socket address (protocol/network address/port) is normally permitted.</span><br><span class="line">exit status 1</span><br></pre></td></tr></table></figure>
<p>If you have such error, you forgot to comment one line <code>fmt.Fprintf(w, &quot;Search received: %s %s %s&quot;, lat, lon, ran)</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Search received: %!s(float64=37.4) %...</span><br></pre></td></tr></table></figure>
<p>Step 2.2.10 Open Postman, find the post query from history. (POST, <a href="http://localhost:8080/post" target="_blank" rel="noopener">http://localhost:8080/post</a>)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"user"</span>:<span class="string">"1111"</span>,</span><br><span class="line">	<span class="attr">"message"</span>:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">	<span class="attr">"location"</span>:&#123;</span><br><span class="line">		<span class="attr">"lat"</span>:<span class="number">37.5</span>,</span><br><span class="line">		<span class="attr">"lon"</span>:<span class="number">-120.1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And then find the get query from history. (GET, url=<a href="http://localhost:8080/search?lat=37.5&amp;lon=-120" target="_blank" rel="noopener">http://localhost:8080/search?lat=37.5&amp;lon=-120</a>)<br>You should get the results back</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"user"</span>: <span class="string">"1111"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">        <span class="attr">"location"</span>: &#123;</span><br><span class="line">            <span class="attr">"lat"</span>: <span class="number">37.5</span>,</span><br><span class="line">            <span class="attr">"lon"</span>: <span class="number">-120.1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Post more examples with different locations and then get with different lat/lon to see how many results you may get. If you have zero result back and no error, probably your geo location is wrong.</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/Go Basic & Around project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/Go Basic & Around project/" class="post-title-link" itemprop="url">Go Basic &amp; Around project</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-28 20:25:31 / Modified: 13:26:45" itemprop="dateCreated datePublished" datetime="2019-04-28T20:25:31-07:00">2019-04-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">8.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">8 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Project-Introduction"><a href="#Project-Introduction" class="headerlink" title="Project Introduction"></a>Project Introduction</h1><p><strong>Around</strong>: a Geo-index based social network</p>
<p>•    Built a scalable web service in Go to handle posts and deployed to Google Cloud (GAE flex) for better scaling</p>
<p>•    Utilized ElasticSearch (GCE) to provide geo-location based search functions such that users can search nearby posts within a distance (e.g. 200km)</p>
<p>•    Used Google Dataflow to implement a daily dump of posts to BigQuery table for offline analysis</p>
<p>•    Aggregated the data at the post level and user level to improve the keyword based spam detection (BigQuery)</p>
<p><strong><code>constants.js</code></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export const API_ROOT = &apos;https://around-75015.appspot.com&apos;;</span><br><span class="line">export const TOKEN_KEY = &apos;TOKEN&apos;;</span><br><span class="line">export const AUTH_PREFIX = &apos;Bearer&apos;;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/1.%20Go%20and%20Web%20Service-2019-4-27-13-55-46.png" alt="1. Go and Web Service-2019-4-27-13-55-46.png"></p>
<h1 id="Why-we-need-to-learn-about-Go"><a href="#Why-we-need-to-learn-about-Go" class="headerlink" title="Why we need to learn about Go?"></a>Why we need to learn about Go?</h1><p><strong>Answer</strong>: server language for next generation (both computer friendly and developer friendly)</p>
<h2 id="Who-is-using-Golang"><a href="#Who-is-using-Golang" class="headerlink" title="Who is using Golang"></a>Who is using Golang</h2><ul>
<li>Google (Creator), Uber, AirBnb</li>
<li>Dropbox, Facebook, eBay, Heroku, Douban, Jingdong, Meituan</li>
</ul>
<p>As opposed to Java, Go is compiled to machine code and is executed directly. Much like C. </p>
<p>Go example</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">"filename.ext"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Other benefits</p>
<ul>
<li>Multiple return values</li>
<li>Multi-threading<ul>
<li>Go Routine</li>
<li>Channels</li>
</ul>
</li>
<li>Has borrowed many good ideas from python</li>
</ul>
<p>Python is really easy to break.</p>
<ul>
<li>Does not compile. You will never know it breaks until it breaks.</li>
<li>Language is confusing.</li>
<li>Good for testing and evaluation with many excellent machine learning libraries.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = set([<span class="string">'hippo'</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">set([<span class="string">'hippo'</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = set(<span class="string">'hippo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">set([<span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'p'</span>, <span class="string">'o'</span>])</span><br></pre></td></tr></table></figure>
<h1 id="Setup-Local-Environment-Go"><a href="#Setup-Local-Environment-Go" class="headerlink" title="Setup Local Environment (Go)"></a>Setup Local Environment (Go)</h1><p>Make sure you have installed Go based on Prerequisite.<br>Mac Users (Windows User wait a minute)</p>
<p>Step 1.1.1 Open Terminal, enter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go version</span><br></pre></td></tr></table></figure>
<p>It should show something like <code>go version go1.10.2 darwin/amd64</code>.</p>
<p>Step 1.1.2(Optional: GOPATH default to ~/go) In the same Terminal, enter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/go</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">export</span> GOPATH=~/go &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$GOPATH</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In here we must not overwrite the bin of go, add <code>export PATH=$PATH:/usr/local/go/bin to .bash_profile and update zsh profile</code></p>
</blockquote>
<p>Step 1.1.3 In the same Terminal, enter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p  ~/Documents/Around/service</span><br><span class="line"><span class="built_in">cd</span>  ~/Documents/Around/service</span><br><span class="line">vim main.go</span><br></pre></td></tr></table></figure>
<p>Step 1.1.4 Type ‘a’ or ‘i’ and then copy a hello world program into main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.1.5 Exit with <code>:wq</code> , in the terminal, type</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure>
<p>You should be able to see the output of <code>“Hello, world”</code></p>
<h1 id="First-Go-program"><a href="#First-Go-program" class="headerlink" title="First Go program"></a>First Go program</h1><p>First, we need to define some objects in a Go program to represent the data we store. </p>
<p>Step 1.3.1 let’s define the struct for post and location. </p>
<p>Encode json object (<a href="https://golang.org/pkg/encoding/json/" target="_blank" rel="noopener">https://golang.org/pkg/encoding/json/</a>)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> &#123;</span><br><span class="line">      Lat <span class="keyword">float64</span> <span class="string">`json:"lat"`</span></span><br><span class="line">      Lon <span class="keyword">float64</span> <span class="string">`json:"lon"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Post <span class="keyword">struct</span> &#123;</span><br><span class="line">      <span class="comment">// `json:"user"` is for the json parsing of this User field. Otherwise, by default it's 'User'.</span></span><br><span class="line">      User     <span class="keyword">string</span> <span class="string">`json:"user"`</span></span><br><span class="line">      Message  <span class="keyword">string</span>  <span class="string">`json:"message"`</span></span><br><span class="line">      Location Location <span class="string">`json:"location"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.3.2 Add one method <code>handlerPost()</code> after <code>main()</code> to handle Post. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerPost</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      <span class="comment">// Parse from body of request to get a json object.</span></span><br><span class="line">      fmt.Println(<span class="string">"Received one post request"</span>)</span><br><span class="line">      decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> p Post</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      fmt.Fprintf(w, <span class="string">"Post received: %s\n"</span>, p.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In here if you add rawString <code>json:&quot;lat&quot;</code> after variable, it will parse it automatically</p>
</blockquote>
<p>What does this method do? If user sends a http request with a body as</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  “user”: “jack”</span><br><span class="line">  “message”: “this is a message”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then it will automatically construct a Post object named <code>p</code> and update its values to be <code>p.User = “jack”</code> and <code>p.Message = “this  is a message”</code></p>
<p><code>Fmt</code> <code>%s</code> means string</p>
<p>Just one line of code to decode json object into go object. In comparison, if you do it in java. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">JSONObject venue = getVenue(event);</span><br><span class="line">      <span class="keyword">if</span> (venue != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"address"</span>)) &#123;</span><br><span class="line">          JSONObject address = venue.getJSONObject(<span class="string">"address"</span>);</span><br><span class="line">          StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">          <span class="keyword">if</span> (!address.isNull(<span class="string">"line1"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            sb.append(address.getString(<span class="string">"line1"</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!address.isNull(<span class="string">"line2"</span>)) &#123;</span><br><span class="line">            sb.append(address.getString(<span class="string">"line2"</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!address.isNull(<span class="string">"line3"</span>)) &#123;</span><br><span class="line">            sb.append(address.getString(<span class="string">"line3"</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          builder.setAddress(sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"city"</span>)) &#123;</span><br><span class="line">          JSONObject city = venue.getJSONObject(<span class="string">"city"</span>);</span><br><span class="line">          builder.setCity(getStringFieldOrNull(city, <span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"country"</span>)) &#123;</span><br><span class="line">          JSONObject country = venue.getJSONObject(<span class="string">"country"</span>);</span><br><span class="line">          builder.setCountry(getStringFieldOrNull(country, <span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"state"</span>)) &#123;</span><br><span class="line">          JSONObject state = venue.getJSONObject(<span class="string">"state"</span>);</span><br><span class="line">          builder.setState(getStringFieldOrNull(state, <span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        builder.setZipcode(getStringFieldOrNull(venue, <span class="string">"postalCode"</span>));</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"location"</span>)) &#123;</span><br><span class="line">          JSONObject location = venue.getJSONObject(<span class="string">"location"</span>);</span><br><span class="line">          builder.setLatitude(getNumericFieldOrNull(location, <span class="string">"latitude"</span>));</span><br><span class="line">          builder.setLongitude(getNumericFieldOrNull(location, <span class="string">"longitude"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.3.3 Replace main function to call handlerPost when started. Final version:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">      http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.3.5 Open your postman,<br>Choose ‘POST’, the url is <a href="http://localhost:8080/post" target="_blank" rel="noopener">http://localhost:8080/post</a>, in the request body, enter<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"user"</span>:<span class="string">"1111"</span>,</span><br><span class="line">	<span class="attr">"message"</span>:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">	<span class="attr">"location"</span>:&#123;</span><br><span class="line">		<span class="attr">"lat"</span>:<span class="number">37.5</span>,</span><br><span class="line">		<span class="attr">"lon"</span>:<span class="number">-120.1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Click ‘Send’, you should be able to see a response with</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post received: 一生必去的100个地方</span><br></pre></td></tr></table></figure>
<p>Add another handler for <code>search</code> (called it <code>handlerSearch</code>), the request has a url pattern like<br><a href="http://localhost:8080/search?lat=10.0&amp;lon=20.0" target="_blank" rel="noopener">http://localhost:8080/search?lat=10.0&amp;lon=20.0</a>. Parse it and then print out the lat and lon.</p>
<p>Note: to get request parameters from url</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lat := r.URL.Query().Get(<span class="string">"lat"</span>)</span><br></pre></td></tr></table></figure>
<p>Step 1.3.6 Answer<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">      http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">      http.HandleFunc(<span class="string">"/search"</span>, handlerSearch)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one request for search"</span>)</span><br><span class="line">      lat := r.URL.Query().Get(<span class="string">"lat"</span>)</span><br><span class="line">      lon := r.URL.Query().Get(<span class="string">"lon"</span>)</span><br><span class="line"></span><br><span class="line">      fmt.Fprintf(w, <span class="string">"Search received: %s %s"</span>, lat, lon)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step 1.3.7  return a JSON object. Change handlerSearch to be</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Import (</span><br><span class="line">      …</span><br><span class="line">      <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">      DISTANCE = <span class="string">"200km"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one request for search"</span>)</span><br><span class="line">      lat, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lat"</span>), <span class="number">64</span>)</span><br><span class="line">      lon, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lon"</span>), <span class="number">64</span>)</span><br><span class="line">      <span class="comment">// range is optional </span></span><br><span class="line">      ran := DISTANCE </span><br><span class="line">      <span class="keyword">if</span> val := r.URL.Query().Get(<span class="string">"range"</span>); val != <span class="string">""</span> &#123; </span><br><span class="line">         ran = val + <span class="string">"km"</span> </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      fmt.Println(<span class="string">"range is "</span>, ran)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Return a fake post</span></span><br><span class="line">      p := &amp;Post&#123;</span><br><span class="line">             User:<span class="string">"1111"</span>,</span><br><span class="line">             Message:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">             Location: Location&#123;</span><br><span class="line">                    Lat:lat,</span><br><span class="line">                    Lon:lon,</span><br><span class="line">             &#125;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      js, err := json.Marshal(p)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">      w.Write(js)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在Go里面，变量必须得用到，不然会报错，除非用下划线做变量名</p>
</blockquote>
<p>Step 1.3.8 Open Postman, url is <a href="http://localhost:8080/search?lat=10.0&amp;lon=20.0&amp;range=300" target="_blank" rel="noopener">http://localhost:8080/search?lat=10.0&amp;lon=20.0&amp;range=300</a> click send again. You should see something like this</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user"</span>: <span class="string">"1111"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">    <span class="attr">"location"</span>: &#123;</span><br><span class="line">        <span class="attr">"lat"</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">"lon"</span>: <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/[Notes] Git notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/[Notes] Git notes/" class="post-title-link" itemprop="url">[Notes] Git notes</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-28 00:02:06 / Modified: 10:55:50" itemprop="dateCreated datePublished" datetime="2019-04-28T00:02:06-07:00">2019-04-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">512</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">1 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Create-a-remote-repository-and-push"><a href="#Create-a-remote-repository-and-push" class="headerlink" title="Create a remote repository and push"></a>Create a remote repository and push</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -am &apos;init&apos;</span><br><span class="line"></span><br><span class="line">git config --local user.name username</span><br><span class="line">git config --local user.email email</span><br><span class="line"></span><br><span class="line">git config --list   //check config</span><br><span class="line"></span><br><span class="line">git config --local core.ignorecase false // turn case sensitivity off</span><br><span class="line"></span><br><span class="line">// use http to connect</span><br><span class="line">curl -u username https://api.github.com/user/repos -d &apos;&#123;&quot;name&quot;:&quot;RepoName&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line">// update</span><br><span class="line">git remote add origin git@github.com:username/RepoName.git </span><br><span class="line"></span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/[Notes] Cloud Computing Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/18/[Notes] Cloud Computing Basic/" class="post-title-link" itemprop="url">[Notes] Cloud Computing Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-18 19:26:54 / Modified: 12:28:15" itemprop="dateCreated datePublished" datetime="2019-04-18T19:26:54-07:00">2019-04-18</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">11k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">10 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Implement-verifyLogin-and-getFullname"><a href="#Implement-verifyLogin-and-getFullname" class="headerlink" title="Implement verifyLogin and getFullname"></a>Implement verifyLogin and getFullname</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the first name and last name and concat them to full name, given the userId</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFullname</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    String name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">        ResultSet res = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">if</span> (res.next()) name = String.join(<span class="string">" "</span>, res.getString(<span class="string">"first_name"</span>), res.getString(<span class="string">"last_name"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Verify the userId and password</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifyLogin</span><span class="params">(String userId, String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT user_id FROM users WHERE user_id = ? AND password = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">        stmt.setString(<span class="number">2</span>, password);</span><br><span class="line">        ResultSet res = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">if</span> (res.next()) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Make-search-result-aware-of-favorite-history"><a href="#Make-search-result-aware-of-favorite-history" class="headerlink" title="Make search result aware of favorite history"></a>Make search result aware of favorite history</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * get the info from request, query, and response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    String userId = request.getParameter(<span class="string">"user_id"</span>);</span><br><span class="line">    <span class="keyword">double</span> lat = Double.parseDouble(request.getParameter(<span class="string">"lat"</span>));</span><br><span class="line">    <span class="keyword">double</span> lon = Double.parseDouble(request.getParameter(<span class="string">"lon"</span>));</span><br><span class="line">    </span><br><span class="line">    String keyword = request.getParameter(<span class="string">"term"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Connect db first</span></span><br><span class="line">    DBConnection conn = DBConnectionFactory.getConnection();</span><br><span class="line">    List&lt;Item&gt; items = conn.searchItems(lat, lon, keyword);</span><br><span class="line">    </span><br><span class="line">    Set&lt;String&gt; favorite = conn.getFavoriteItemIds(userId);</span><br><span class="line">    conn.close();</span><br><span class="line">    </span><br><span class="line">    JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Item item : items) &#123;</span><br><span class="line">            JSONObject obj = item.toJSONObject();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// check if current item is a favorite item</span></span><br><span class="line">            <span class="comment">// this field is required by front end to control the fav status</span></span><br><span class="line">            obj.put(<span class="string">"favorite"</span>, favorite.contains(item.getItemId()));</span><br><span class="line">            array.put(obj);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    RpcHelper.writeJSONArray(response, array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="What’s-Cloud-Computing"><a href="#What’s-Cloud-Computing" class="headerlink" title="What’s Cloud Computing"></a>What’s Cloud Computing</h1><p>Cloud computing is the delivery of on-demand computing resources—everything from applications to data centers—over the Internet on a pay-for-use basis.</p>
<p>Since 2006 when Amazon introduced the Elastic Compute Cloud</p>
<p>Features:</p>
<ul>
<li>scalability,</li>
<li>flexibility,</li>
<li>on-demand,</li>
<li>reduced labor cost and data center cost, handled by SREs</li>
</ul>
<p>Bad</p>
<ul>
<li>data safety and privacy</li>
<li>cannot control downtime</li>
</ul>
<p>Types</p>
<ul>
<li>private cloud (VMware)</li>
<li>public cloud (Microsoft Azure, Google App Engine, Amazon EC2)</li>
<li>hybrid cloud</li>
</ul>
<h1 id="Amazon-EC2"><a href="#Amazon-EC2" class="headerlink" title="Amazon EC2"></a>Amazon EC2</h1><h2 id="Elastic-Compute-Cloud-EC2"><a href="#Elastic-Compute-Cloud-EC2" class="headerlink" title="Elastic Compute Cloud (EC2)"></a>Elastic Compute Cloud (EC2)</h2><p>EC2 allows scalable deployment of applications by providing a Web service through which a user can boot an Amazon Machine Image to create a virtual machine, which Amazon calls an “instance”, containing any software desired. A user can create, launch, and terminate server instances as needed, paying by the hour for active servers, hence the term “elastic”.</p>
<h2 id="Launch-an-instance-Ubuntu-linux"><a href="#Launch-an-instance-Ubuntu-linux" class="headerlink" title="Launch an instance (Ubuntu linux)"></a>Launch an instance (Ubuntu linux)</h2><p>Step 1, go to <a href="http://aws.amazon.com" target="_blank" rel="noopener">http://aws.amazon.com</a>, sign into your account and then open EC2 dashboard. Launch an instance.</p>
<p>Step 2, Select the Ubuntu Server 16.04 image.</p>
<p>Step 3, Use t2.micro as instance, which is free tier eligible. Click next instead of launch.</p>
<p>Step 4, Jump to security group setup. You need to add 2 more TCP ports: 80, 8080.</p>
<p>Step 5, Click Launch, you will be asked to create a new key pair and download the private key. You can name it as mykey.pem</p>
<h2 id="Connect-to-the-instance"><a href="#Connect-to-the-instance" class="headerlink" title="Connect to the instance"></a>Connect to the instance</h2><h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>Open your terminal, run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 ~/Downloads/mykey.pem</span><br><span class="line">ssh -i ~/Downloads/mykey.pem ubuntu@YOUR_INSTANCE_IP</span><br></pre></td></tr></table></figure></p>
<p>if asked “Are you sure you want to continue connecting (yes/no)? ”, type “yes”, enter.</p>
<p>You are now on the remote server, you can play with Linux commands. <code>hostname, ifconfig, whoami, uptime, pwd, ls</code></p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows (Putty)</p>
<ul>
<li><p>Download Putty and Puttygen from <a href="https://the.earth.li/~sgtatham/putty/latest/x86/putty.zip" target="_blank" rel="noopener">https://the.earth.li/~sgtatham/putty/latest/x86/putty.zip</a> </p>
</li>
<li><p>Open Puttygen,  “Conversions”-&gt;”Import key”, select mykey.pem file, Save private key as mykey.ppk</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/14.%20Cloud%20Computing-2019-4-17-20-13-19.png" alt="14. Cloud Computing-2019-4-17-20-13-19.png"></p>
<ul>
<li>Open Putty, enter host ip, in SSH-&gt;Auth, choose your ppk file</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/14.%20Cloud%20Computing-2019-4-17-20-13-30.png" alt="14. Cloud Computing-2019-4-17-20-13-30.png"></p>
<ul>
<li>Click Open, enter the username ubuntu</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/14.%20Cloud%20Computing-2019-4-17-20-13-42.png" alt="14. Cloud Computing-2019-4-17-20-13-42.png"></p>
<h2 id="Install-Java"><a href="#Install-Java" class="headerlink" title="Install Java"></a>Install Java</h2><p>Step 1, In your instance’s terminal, execute the following commands:</p>
<ul>
<li>sudo apt-get update</li>
<li>sudo apt-get install default-jre</li>
</ul>
<p>Step 2, You can verify with</p>
<ul>
<li>java -version</li>
</ul>
<h2 id="Install-MySQL"><a href="#Install-MySQL" class="headerlink" title="Install MySQL"></a>Install MySQL</h2><p>Step 1, sudo apt-get install mysql-server. When you are asked for new mysql password, use “root”.</p>
<p>Step 2, after installation, type <code>mysql -u root -p</code> in your terminal, then input the “root” as password.</p>
<p>Step 3, In the mysql shell, paste the following SQL statements to install the tables:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> myproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> myproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> myproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> items (item_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>), rating <span class="built_in">FLOAT</span>, address <span class="built_in">VARCHAR</span>(<span class="number">255</span>), image_url <span class="built_in">VARCHAR</span>(<span class="number">255</span>), <span class="keyword">url</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>), distance <span class="built_in">FLOAT</span>, PRIMARY <span class="keyword">KEY</span> ( item_id));</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> categories (item_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="keyword">category</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, PRIMARY <span class="keyword">KEY</span> ( item_id, <span class="keyword">category</span>), <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (item_id) <span class="keyword">REFERENCES</span> items(item_id));    </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">users</span> (user_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="keyword">password</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, first_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>), last_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>), PRIMARY <span class="keyword">KEY</span> ( user_id ));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> history (user_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, item_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, last_favor_time <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>, PRIMARY <span class="keyword">KEY</span> (user_id, item_id), <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (item_id) <span class="keyword">REFERENCES</span> items(item_id), <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (user_id) <span class="keyword">REFERENCES</span> <span class="keyword">users</span>(user_id));</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">users</span> <span class="keyword">VALUES</span> (<span class="string">"1111"</span>, <span class="string">"3229c1097c00d497a0fd282d586be050"</span>, <span class="string">"John"</span>, <span class="string">"Smith"</span>);</span><br></pre></td></tr></table></figure>
<p>Step 4, Type “exit” to quit mysql shell.</p>
<h2 id="Install-Tomcat-9"><a href="#Install-Tomcat-9" class="headerlink" title="Install Tomcat 9"></a>Install Tomcat 9</h2><p>Step 1, Execute the following commands<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">sudo wget http://apache.mirrors.hoobly.com/tomcat/tomcat-9/v9.0.19/bin/apache-tomcat-9.0.19.tar.gz</span><br><span class="line">sudo tar xzf apache-tomcat-9.0.8.tar.gz</span><br><span class="line">sudo ln -s apache-tomcat-9.0.8 tomcat</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export CATALINA_HOME=\"/opt/tomcat\""</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="built_in">cd</span> /opt/tomcat</span><br><span class="line">sudo bin/startup.sh</span><br></pre></td></tr></table></figure></p>
<p>Step 2, Verify with <a href="http://YOUR_INSTANCE_IP:8080/" target="_blank" rel="noopener">http://YOUR_INSTANCE_IP:8080/</a></p>
<h2 id="Run-Jupiter-on-EC2"><a href="#Run-Jupiter-on-EC2" class="headerlink" title="Run Jupiter on EC2"></a>Run Jupiter on EC2</h2><p><code>WAR</code> file (or Web application ARchive) is a JAR file used to distribute a collection of JavaServer Pages, Java Servlets, Java classes, XML files, tag libraries, static web pages (HTML and related files) and other resources that together constitute a web application.</p>
<p>Step 1, Open Eclipse and MAMP, verify your website works correctly on local environment:<br><a href="http://localhost:8080/Jupiter/" target="_blank" rel="noopener">http://localhost:8080/Jupiter/</a></p>
<p>Step 2, open your MySQLDBUtil.java, change and make sure port is 3306, and username and password are root.</p>
<blockquote>
<p>3306 is default port in MySQL</p>
</blockquote>
<p>Step 3, In Eclipse, select File -&gt; Export -&gt; Web-&gt;war File, save the war file to disk.</p>
<p>Step 4, Copy the war file to your instance.</p>
<p><strong><code>MAC</code></strong>:<br>Open a new terminal window and type:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i ~/Downloads/mykey.pem  ~/Downloads/Jupiter.war ubuntu@YOUR_INSTANCE_IP:~/</span><br></pre></td></tr></table></figure></p>
<p>Windows (MSYS2): </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i /c/Users/&lt;YOUR_USERNAME&gt;/Downloads/mykey.pem  /c/Users/&lt;YOUR_PATH&gt;/Jupiter.war ubuntu@YOUR_INSTANCE_IP:~/</span><br></pre></td></tr></table></figure>
<p>Windows (putty):<br>use WinSCP, <a href="https://winscp.net/download/WinSCP-5.13.2-Setup.exe" target="_blank" rel="noopener">https://winscp.net/download/WinSCP-5.13.2-Setup.exe</a></p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/14.%20Cloud%20Computing-2019-4-18-10-31-3.png" alt="14. Cloud Computing-2019-4-18-10-31-3.png"></p>
<p>Click Advanced-&gt;SSH-&gt;Authentication-&gt;Private key file: choose *.ppk </p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/14.%20Cloud%20Computing-2019-4-18-10-31-14.png" alt="14. Cloud Computing-2019-4-18-10-31-14.png"></p>
<p>Drag the Jupiter.war to the left (into /home/ubuntu/).</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/14.%20Cloud%20Computing-2019-4-18-10-31-26.png" alt="14. Cloud Computing-2019-4-18-10-31-26.png"></p>
<p>Step 5, Both Mac and Windows, back to your terminal/putty, type the following command</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ~/Jupiter.war /opt/tomcat/webapps/</span><br></pre></td></tr></table></figure>
<p>Step 6, Wait for a few seconds, then you can verify the server on your browser:<br><a href="http://YOUR_INSTANCE_IP:8080/Jupiter/" target="_blank" rel="noopener">http://YOUR_INSTANCE_IP:8080/Jupiter/</a></p>
<p><strong>Redeploy application</strong>: redo step 3-5.</p>
<h2 id="Debug-configuration"><a href="#Debug-configuration" class="headerlink" title="Debug configuration"></a>Debug configuration</h2><p>此处需要将eclipse的jdk jre compiler全部设为1.8并重新编译，即可解决版本问题。</p>
<h2 id="optional-Change-the-HTTP-port-from-8080-to-80"><a href="#optional-Change-the-HTTP-port-from-8080-to-80" class="headerlink" title="(optional) Change the HTTP port from 8080 to 80"></a>(optional) Change the HTTP port from 8080 to 80</h2><p>Step 1, On the remote command-line terminal, edit the tomcat configuration by:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /opt/tomcat/conf/server.xml</span><br></pre></td></tr></table></figure>
<p>Step 2, Press i to enter edit mode, scroll down to find the following line (around line 69):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">change &quot;8080&quot; to &quot;80&quot;</span><br></pre></td></tr></table></figure>
<p>Step 3, Press <code>ESC</code> to exit edit mode, then type <code>:wq</code> to save and exit.</p>
<p>Step 4, Restart tomcat by:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /opt/tomcat/bin/shutdown.sh</span><br><span class="line">sudo /opt/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>Step 5, Visit <a href="http://YOUR_IP_ADDRESS/Jupiter/" target="_blank" rel="noopener">http://YOUR_IP_ADDRESS/Jupiter/</a> to see if the server is started correctly.</p>
<blockquote>
<p>此处端口设为80，以后访问时就不需要再额外输入端口号了</p>
</blockquote>
<h2 id="optional-Make-tomcat-auto-start-when-Linux-boots"><a href="#optional-Make-tomcat-auto-start-when-Linux-boots" class="headerlink" title="(optional) Make tomcat auto start when Linux boots"></a>(optional) Make tomcat auto start when Linux boots</h2><p>Step 1, On you instance’s terminal, type the following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/init.d/tomcat</span><br></pre></td></tr></table></figure>
<p>Step 2, Press i to enter the INSERT mode, then paste the following contents:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides: tomcat</span></span><br><span class="line"><span class="comment"># Required-Start: $network</span></span><br><span class="line"><span class="comment"># Required-Stop: $network</span></span><br><span class="line"><span class="comment"># Default-Start: 2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop: 0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: Start/Stop Tomcat server</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line"> sh /opt/tomcat/bin/startup.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line"> sh /opt/tomcat/bin/shutdown.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">  start|stop) <span class="variable">$1</span>;;</span><br><span class="line">  restart) stop; start;;</span><br><span class="line">  *) <span class="built_in">echo</span> <span class="string">"Run as <span class="variable">$0</span> &lt;start|stop|restart&gt;"</span>; <span class="built_in">exit</span> 1;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<p>Step 3, Press Esc to exit INSERT mode, then type <code>:wq</code> to save and quit.</p>
<p>Step 4, Make the new file executable: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/init.d/tomcat</span><br></pre></td></tr></table></figure>
<p>Step 5, update <code>bashrc</code> to catch your script:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-rc.d tomcat defaults</span><br></pre></td></tr></table></figure>
<p>Step 6, (optional) you can use <code>sudo /etc/init.d/tomcat restart</code> to manually restart tomcat.</p>
<h2 id="optional-Make-tomcat-auto-restart-everyday"><a href="#optional-Make-tomcat-auto-restart-everyday" class="headerlink" title="(optional) Make tomcat auto restart everyday"></a>(optional) Make tomcat auto restart everyday</h2><p>Your web app may be not that stable to run for months. You can restart it every night to keep it healthy.</p>
<p>Step 1, On you instance’s terminal, type the following command: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crontab -e</span><br></pre></td></tr></table></figure>
<p>Step 2, Input <code>3</code> to select <code>vim.basic</code> as the editor</p>
<p>Step 3, Move the cursor to the end, press i to enter edit mode. Input the following, It means restart tomcat at 1:00 and 13:00 UTC everyday.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1,13   *   *   *   sudo /etc/init.d/tomcat restart</span><br></pre></td></tr></table></figure>
<blockquote>
<p>定时在1:00和13:00tomcat重启</p>
</blockquote>
<p>Step 4, Press Esc to exit INSERT mode, then type :wq to save and quit.</p>
<h1 id="Remote-debug"><a href="#Remote-debug" class="headerlink" title="Remote debug:"></a>Remote debug:</h1><p>You can check Java error from Tomcat runtime log. Location:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/tomcat/logs/localhost.&lt;date&gt;.log</span><br></pre></td></tr></table></figure>
<ul>
<li>Check tomcat process:<br><code>ps aux|grep tomcat</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root     17273 78.3  7.9 2225932 80404 pts/0   Sl   20:30   0:02 /usr/bin/java -Djava.util.logging.config.file=/opt/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /opt/tomcat/bin/bootstrap.jar:/opt/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/opt/tomcat -Dcatalina.home=/opt/tomcat -Djava.io.tmpdir=/opt/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br></pre></td></tr></table></figure>
<blockquote>
<p>17273 is the process id</p>
</blockquote>
<ul>
<li>To kill the process</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sudo kill -9 17273</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/[Notes] AJAX Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/18/[Notes] AJAX Basic/" class="post-title-link" itemprop="url">[Notes] AJAX Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-18 02:00:51" itemprop="dateCreated datePublished" datetime="2019-04-18T02:00:51-07:00">2019-04-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-17 19:01:37" itemprop="dateModified" datetime="2019-04-17T19:01:37-07:00">2019-04-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">9.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">9 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-AJAX"><a href="#What-is-AJAX" class="headerlink" title="What is AJAX?"></a>What is AJAX?</h1><p>AJAX is not a programming language.<br>AJAX just uses a combination of:</p>
<ul>
<li>A browser built-in XMLHttpRequest object (to request data from a web server)</li>
<li>JavaScript and HTML DOM (to display or use the data)</li>
</ul>
<blockquote>
<p>AJAX 可以实现异步通信</p>
</blockquote>
<h1 id="How-AJAX-Works"><a href="#How-AJAX-Works" class="headerlink" title="How AJAX Works"></a>How AJAX Works</h1><p><img src="https://raw.githubusercontent.com/Luorinz/images/master/13.%20AJAX%20Basic-2019-4-17-13-40-54.png" alt="13. AJAX Basic-2019-4-17-13-40-54.png"></p>
<h1 id="How-to-use-AJAX"><a href="#How-to-use-AJAX" class="headerlink" title="How to use AJAX"></a>How to use AJAX</h1><p>The keystone of AJAX is the XMLHttpRequest object.</p>
<h2 id="creating-an-XMLHttpRequest-object"><a href="#creating-an-XMLHttpRequest-object" class="headerlink" title="creating an XMLHttpRequest object"></a>creating an XMLHttpRequest object</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br></pre></td></tr></table></figure>
<h2 id="send-a-request-to-a-server-we-use-the-open-and-send-methods-of-the-XMLHttpRequest-object"><a href="#send-a-request-to-a-server-we-use-the-open-and-send-methods-of-the-XMLHttpRequest-object" class="headerlink" title="send a request to a server, we use the open() and send() methods of the XMLHttpRequest object"></a>send a request to a server, we use the <code>open()</code> and <code>send()</code> methods of the <code>XMLHttpRequest</code> object</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xhttp.open(<span class="string">"GET"</span>, <span class="string">"ajax_info.txt"</span>, <span class="literal">true</span>);</span><br><span class="line">xhttp.send();</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/13.%20AJAX%20Basic-2019-4-17-13-46-10.png" alt="13. AJAX Basic-2019-4-17-13-46-10.png"></p>
<h2 id="GET-or-POST"><a href="#GET-or-POST" class="headerlink" title="GET or POST?"></a>GET or POST?</h2><p>GET is simpler and faster than POST, and can be used in most cases.<br>However, always use POST requests when:</p>
<ul>
<li>A cached file is not an option (update a file or database on the server).</li>
<li>Sending a large amount of data to the server (POST has no size limitations).</li>
<li>Sending user input (which can contain unknown characters), POST is more robust and secure than GET.</li>
</ul>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>demo of our web applications: <a href="http://34.211.21.63/Event/" target="_blank" rel="noopener">http://34.211.21.63/Event/</a> </p>
<h1 id="Complete-HTML-CSS-Javascript-code"><a href="#Complete-HTML-CSS-Javascript-code" class="headerlink" title="Complete HTML/CSS/Javascript code"></a>Complete HTML/CSS/Javascript code</h1><p><a href="http://jsbin.com/hocukukiva/edit?html,css,js" target="_blank" rel="noopener">http://jsbin.com/hocukukiva/edit?html,css,js</a></p>
<p>将JSBin里面的代码分别放在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/WebContent/index.html</span><br><span class="line">/WebContent/styles/main.css</span><br><span class="line">/WebContent/scripts/main.js</span><br></pre></td></tr></table></figure></p>
<p>访问： <a href="http://localhost:8080/Jupiter" target="_blank" rel="noopener">http://localhost:8080/Jupiter</a></p>
<blockquote>
<p>自动跳转至index.html<br><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset</a></p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">font-size</span>: 0<span class="selector-class">.9em</span>; </span><br><span class="line"><span class="comment">/* means 0.9 * parent's font-size  */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.top-nav</span> &#123;</span><br><span class="line">	<span class="comment">/* flex means listed from left to right  */</span></span><br><span class="line">	<span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h1><h2 id="Step-1-Run-the-scripts"><a href="#Step-1-Run-the-scripts" class="headerlink" title="Step 1 ()() Run the scripts"></a>Step 1 ()() Run the scripts</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run all following scripts</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h2 id="Step-2-Gloval-Variables"><a href="#Step-2-Gloval-Variables" class="headerlink" title="Step 2 Gloval Variables"></a>Step 2 Gloval Variables</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user_id = <span class="string">'1111'</span>;</span><br><span class="line"><span class="keyword">var</span> user_fullname = <span class="string">'John Smith'</span>;</span><br><span class="line"><span class="keyword">var</span> lng = <span class="number">-122.08</span>;</span><br><span class="line"><span class="keyword">var</span> lat = <span class="number">37.38</span>;</span><br></pre></td></tr></table></figure>
<h2 id="step3-main-function-entrance"><a href="#step3-main-function-entrance" class="headerlink" title="step3: main function(entrance)"></a>step3: main function(entrance)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">init();</span><br><span class="line"><span class="comment">/* step4: define init function */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Register event listeners</span></span><br><span class="line">  $(<span class="string">'nearby-btn'</span>).addEventListener(<span class="string">'click'</span>, loadNearbyItems);</span><br><span class="line"><span class="comment">//		$('fav-btn').addEventListener('click', loadFavoriteItems);</span></span><br><span class="line"><span class="comment">//		$('recommend-btn').addEventListener('click', loadRecommendedItems);</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> welcomeMsg = $(<span class="string">'welcome-msg'</span>);</span><br><span class="line">          welcomeMsg.innerHTML = <span class="string">'Welcome, '</span> + user_fullname;</span><br><span class="line">      </span><br><span class="line">          <span class="comment">// step 7</span></span><br><span class="line">          initGeoLocation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step5-create-function"><a href="#step5-create-function" class="headerlink" title="step5: create $ function"></a>step5: create $ function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A helper function that creates a DOM element &lt;tag options...&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">$</span>(<span class="params">tag, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!options) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.getElementById(tag);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(tag);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( <span class="keyword">var</span> option <span class="keyword">in</span> options) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.hasOwnProperty(option)) &#123;</span><br><span class="line">      element[option] = options[option];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step6-create-AJAX-helper-function"><a href="#step6-create-AJAX-helper-function" class="headerlink" title="step6: create AJAX helper function"></a>step6: create AJAX helper function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param method - GET|POST|PUT|DELETE</span></span><br><span class="line"><span class="comment"> * @param url - API end point</span></span><br><span class="line"><span class="comment"> * @param callback - This the successful callback</span></span><br><span class="line"><span class="comment"> * @param errorHandler - This is the failed callback</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">method, url, data, callback, errorHandler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line">  xhr.open(method, url, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断request</span></span><br><span class="line">  xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断 resopnse</span></span><br><span class="line">    <span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="comment">// callback 属于回调函数</span></span><br><span class="line">      callback(xhr.responseText);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xhr.status === <span class="number">403</span>) &#123;</span><br><span class="line">      onSessionInvalid();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      errorHandler();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  xhr.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"The request couldn't be completed."</span>);</span><br><span class="line">    errorHandler();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data === <span class="literal">null</span>) &#123;</span><br><span class="line">    xhr.send();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    xhr.setRequestHeader(<span class="string">"Content-Type"</span>,</span><br><span class="line">        <span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">    xhr.send(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-7-initGeoLocation-function"><a href="#step-7-initGeoLocation-function" class="headerlink" title="step 7: initGeoLocation function"></a>step 7: initGeoLocation function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initGeoLocation</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (navigator.geolocation) &#123;</span><br><span class="line">    <span class="comment">// step 8</span></span><br><span class="line">    <span class="comment">// get current position by browser.</span></span><br><span class="line">    navigator.geolocation.getCurrentPosition(onPositionUpdated,</span><br><span class="line">        onLoadPositionFailed, &#123;</span><br><span class="line">          maximumAge : <span class="number">60000</span></span><br><span class="line">        &#125;);</span><br><span class="line">    showLoadingMessage(<span class="string">'Retrieving your location...'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// step 9</span></span><br><span class="line">    onLoadPositionFailed();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-8-onPositionUpdated-function"><a href="#step-8-onPositionUpdated-function" class="headerlink" title="step 8: onPositionUpdated function"></a>step 8: onPositionUpdated function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onPositionUpdated</span>(<span class="params">position</span>) </span>&#123;</span><br><span class="line">  lat = position.coords.latitude;</span><br><span class="line">  lng = position.coords.longitude;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// step 11</span></span><br><span class="line">  loadNearbyItems();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-9-onLoadPositionFailed-function"><a href="#step-9-onLoadPositionFailed-function" class="headerlink" title="step 9: onLoadPositionFailed function"></a>step 9: onLoadPositionFailed function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onLoadPositionFailed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.warn(<span class="string">'navigator.geolocation is not available'</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//step 10</span></span><br><span class="line">  getLocationFromIP();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-10-getLocationFromIP-function"><a href="#step-10-getLocationFromIP-function" class="headerlink" title="step 10: getLocationFromIP function"></a>step 10: getLocationFromIP function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLocationFromIP</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Get location from http://ipinfo.io/json</span></span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'http://ipinfo.io/json'</span></span><br><span class="line">  <span class="keyword">var</span> req = <span class="literal">null</span>;</span><br><span class="line">  ajax(<span class="string">'GET'</span>, url, req, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="built_in">JSON</span>.parse(res);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'loc'</span> <span class="keyword">in</span> result) &#123;</span><br><span class="line">      <span class="keyword">var</span> loc = result.loc.split(<span class="string">','</span>);</span><br><span class="line">      lat = loc[<span class="number">0</span>];</span><br><span class="line">      lng = loc[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">'Getting location by IP failed.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// step 11</span></span><br><span class="line">    loadNearbyItems();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-11-loadNearbyItems-function"><a href="#step-11-loadNearbyItems-function" class="headerlink" title="step 11: loadNearbyItems function"></a>step 11: loadNearbyItems function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * API #1 Load the nearby items API end point: [GET]</span></span><br><span class="line"><span class="comment"> * /Dashi/search?user_id=1111&amp;lat=37.38&amp;lon=-122.08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadNearbyItems</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'loadNearbyItems'</span>);</span><br><span class="line">  <span class="comment">// step 12</span></span><br><span class="line">  activeBtn(<span class="string">'nearby-btn'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The request parameters</span></span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'./search'</span>;</span><br><span class="line">  <span class="keyword">var</span> params = <span class="string">'user_id='</span> + user_id + <span class="string">'&amp;lat='</span> + lat + <span class="string">'&amp;lon='</span> + lng;</span><br><span class="line">  <span class="keyword">var</span> req = <span class="built_in">JSON</span>.stringify(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// step 13</span></span><br><span class="line">  <span class="comment">// display loading message</span></span><br><span class="line">  showLoadingMessage(<span class="string">'Loading nearby items...'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make AJAX call</span></span><br><span class="line">  ajax(<span class="string">'GET'</span>, url + <span class="string">'?'</span> + params, req,</span><br><span class="line">  <span class="comment">// successful callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> items = <span class="built_in">JSON</span>.parse(res);</span><br><span class="line">    <span class="keyword">if</span> (!items || items.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// step 14</span></span><br><span class="line">      showWarningMessage(<span class="string">'No nearby item.'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// step 16</span></span><br><span class="line">      listItems(items);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// failed callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// step 15</span></span><br><span class="line">    showErrorMessage(<span class="string">'Cannot load nearby items.'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-12-activeBtn-function"><a href="#step-12-activeBtn-function" class="headerlink" title="step 12: activeBtn function"></a>step 12: activeBtn function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A helper function that makes a navigation button active</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param btnId - The id of the navigation button</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">activeBtn</span>(<span class="params">btnId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> btns = <span class="built_in">document</span>.getElementsByClassName(<span class="string">'main-nav-btn'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// deactivate all navigation buttons</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; btns.length; i++) &#123;</span><br><span class="line">    btns[i].className = btns[i].className.replace(<span class="regexp">/\bactive\b/</span>, <span class="string">''</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// active the one that has id = btnId</span></span><br><span class="line">  <span class="keyword">var</span> btn = $(btnId);</span><br><span class="line">  btn.className += <span class="string">' active'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-13-showLoadingMessage-function"><a href="#step-13-showLoadingMessage-function" class="headerlink" title="step 13: showLoadingMessage function"></a>step 13: showLoadingMessage function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showLoadingMessage</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">'&lt;p class="notice"&gt;&lt;i class="fa fa-spinner fa-spin"&gt;&lt;/i&gt; '</span></span><br><span class="line">      + msg + <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** step 14: showWarningMessage function **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showWarningMessage</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">'&lt;p class="notice"&gt;&lt;i class="fa fa-exclamation-triangle"&gt;&lt;/i&gt; '</span></span><br><span class="line">      + msg + <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** step15: showErrorMessage function **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showErrorMessage</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">'&lt;p class="notice"&gt;&lt;i class="fa fa-exclamation-circle"&gt;&lt;/i&gt; '</span></span><br><span class="line">      + msg + <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step16-listItems-function"><a href="#step16-listItems-function" class="headerlink" title="step16: listItems function"></a>step16: listItems function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param items - An array of item JSON objects</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listItems</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Clear the current results</span></span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">    <span class="comment">// step 17</span></span><br><span class="line">    addItem(itemList, items[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step17-addItem-function"><a href="#step17-addItem-function" class="headerlink" title="step17: addItem function"></a>step17: addItem function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add item to the list</span></span><br><span class="line"><span class="comment"> * @param itemList - The &lt;ul id="item-list"&gt; tag</span></span><br><span class="line"><span class="comment"> * @param item - The item data (JSON object)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addItem</span>(<span class="params">itemList, item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> item_id = item.item_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create the &lt;li&gt; tag and specify the id and class attributes</span></span><br><span class="line">  <span class="keyword">var</span> li = $(<span class="string">'li'</span>, &#123;</span><br><span class="line">    id : <span class="string">'item-'</span> + item_id,</span><br><span class="line">    className : <span class="string">'item'</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the data attribute</span></span><br><span class="line">  li.dataset.item_id = item_id;</span><br><span class="line">  li.dataset.favorite = item.favorite;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// item image</span></span><br><span class="line">  <span class="keyword">if</span> (item.image_url) &#123;</span><br><span class="line">    li.appendChild($(<span class="string">'img'</span>, &#123;</span><br><span class="line">      src : item.image_url</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    li.appendChild($(<span class="string">'img'</span>, &#123;</span><br><span class="line">      src : <span class="string">'https://assets-cdn.github.com/images/modules/logos_page/GitHub-Mark.png'</span></span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// section</span></span><br><span class="line">  <span class="keyword">var</span> section = $(<span class="string">'div'</span>, &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// title</span></span><br><span class="line">  <span class="keyword">var</span> title = $(<span class="string">'a'</span>, &#123;</span><br><span class="line">    href : item.url,</span><br><span class="line">    target : <span class="string">'_blank'</span>,</span><br><span class="line">    className : <span class="string">'item-name'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  title.innerHTML = item.name;</span><br><span class="line">  section.appendChild(title);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// category</span></span><br><span class="line">  <span class="keyword">var</span> category = $(<span class="string">'p'</span>, &#123;</span><br><span class="line">    className : <span class="string">'item-category'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  category.innerHTML = <span class="string">'Category: '</span> + item.categories.join(<span class="string">', '</span>);</span><br><span class="line">  section.appendChild(category);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> stars = $(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className : <span class="string">'stars'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; item.rating; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> star = $(<span class="string">'i'</span>, &#123;</span><br><span class="line">      className : <span class="string">'fa fa-star'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    stars.appendChild(star);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="string">''</span> + item.rating).match(<span class="regexp">/\.5$/</span>)) &#123;</span><br><span class="line">    stars.appendChild($(<span class="string">'i'</span>, &#123;</span><br><span class="line">      className : <span class="string">'fa fa-star-half-o'</span></span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  section.appendChild(stars);</span><br><span class="line"></span><br><span class="line">  li.appendChild(section);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// address</span></span><br><span class="line">  <span class="keyword">var</span> address = $(<span class="string">'p'</span>, &#123;</span><br><span class="line">    className : <span class="string">'item-address'</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  address.innerHTML = item.address.replace(<span class="regexp">/,/g</span>, <span class="string">'&lt;br/&gt;'</span>).replace(<span class="regexp">/\"/g</span>,</span><br><span class="line">      <span class="string">''</span>);</span><br><span class="line">  li.appendChild(address);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// favorite link</span></span><br><span class="line">  <span class="keyword">var</span> favLink = $(<span class="string">'p'</span>, &#123;</span><br><span class="line">    className : <span class="string">'fav-link'</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  favLink.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    changeFavoriteItem(item_id);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  favLink.appendChild($(<span class="string">'i'</span>, &#123;</span><br><span class="line">    id : <span class="string">'fav-icon-'</span> + item_id,</span><br><span class="line">    className : item.favorite ? <span class="string">'fa fa-heart'</span> : <span class="string">'fa fa-heart-o'</span></span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  li.appendChild(favLink);</span><br><span class="line"></span><br><span class="line">  itemList.appendChild(li);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/17/[Notes] Simple Recommendation System/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/17/[Notes] Simple Recommendation System/" class="post-title-link" itemprop="url">[Notes] Simple Recommendation System</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-17 20:06:05 / Modified: 13:07:34" itemprop="dateCreated datePublished" datetime="2019-04-17T20:06:05-07:00">2019-04-17</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">9.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">8 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Continue-to-implement-get-history"><a href="#Continue-to-implement-get-history" class="headerlink" title="Continue to implement get history"></a>Continue to implement get history</h1><h2 id="Implement-getFavoriteItemsmethod"><a href="#Implement-getFavoriteItemsmethod" class="headerlink" title="Implement getFavoriteItemsmethod"></a>Implement getFavoriteItemsmethod</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the favorite items given userId in the history table</span></span><br><span class="line"><span class="comment">    * userId -&gt; itemId -&gt; favorite items</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;Item&gt; <span class="title">getFavoriteItems</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;Item&gt;();</span><br><span class="line">    Set&lt;Item&gt; favoriteItems = <span class="keyword">new</span> HashSet&lt;Item&gt;();</span><br><span class="line">    Set&lt;String&gt; itemIds = getFavoriteItemIds(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT * FROM items WHERE item_id = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        <span class="keyword">for</span> (String itemId: itemIds) &#123;</span><br><span class="line">            stmt.setString(<span class="number">1</span>, itemId);</span><br><span class="line">            <span class="comment">// executeQuery returns a table(ResultSet)</span></span><br><span class="line">            ResultSet res = stmt.executeQuery();</span><br><span class="line">            ItemBuilder builder = <span class="keyword">new</span> ItemBuilder();</span><br><span class="line">            <span class="comment">// iterator</span></span><br><span class="line">            <span class="keyword">while</span> (res.next()) &#123;</span><br><span class="line">                builder.setItemId(res.getString(<span class="string">"item_id"</span>));</span><br><span class="line">                builder.setName(res.getString(<span class="string">"name"</span>));</span><br><span class="line">                builder.setAddress(res.getString(<span class="string">"address"</span>));</span><br><span class="line">                builder.setImageUrl(res.getString(<span class="string">"image_url"</span>));</span><br><span class="line">                builder.setUrl(res.getString(<span class="string">"url"</span>));</span><br><span class="line">                builder.setCategories(getCategories(itemId));</span><br><span class="line">                builder.setDistance(res.getDouble(<span class="string">"distance"</span>));</span><br><span class="line">                builder.setRating(res.getDouble(<span class="string">"rating"</span>));</span><br><span class="line">                </span><br><span class="line">                </span><br><span class="line">                favoriteItems.add(builder.build());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> favoriteItems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Next-let’s-try-getFavoriteItemIds-and-getCategories"><a href="#Next-let’s-try-getFavoriteItemIds-and-getCategories" class="headerlink" title="Next, let’s try getFavoriteItemIds and getCategories"></a>Next, let’s try getFavoriteItemIds and getCategories</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Given userId, query history table, get corresponding item_id.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getFavoriteItemIds</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    Set&lt;String&gt; favoriteItemIds = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT * FROM history WHERE user_id = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">        ResultSet res = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">while</span> (res.next()) &#123;</span><br><span class="line">            favoriteItemIds.add(res.getString(<span class="string">"item_id"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> favoriteItemIds;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Given itemId, query categories table, get corresponding categories</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getCategories</span><span class="params">(String itemId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    Set&lt;String&gt; categories = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT category FROM categories WHERE item_id = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, itemId);</span><br><span class="line">        ResultSet res = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">while</span> (res.next()) &#123;</span><br><span class="line">            categories.add(res.getString(<span class="string">"category"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> categories;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Get-back-to-ItemHistory-java-update-doGet-method"><a href="#Get-back-to-ItemHistory-java-update-doGet-method" class="headerlink" title="Get back to ItemHistory.java, update doGet method."></a>Get back to <code>ItemHistory.java</code>, update <code>doGet</code> method.</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the user_id from request, query the favorite items, and handle the response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String userId = request.getParameter(<span class="string">"user_id"</span>);</span><br><span class="line">    JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">    </span><br><span class="line">    DBConnection conn = DBConnectionFactory.getConnection();</span><br><span class="line">    Set&lt;Item&gt; items = conn.getFavoriteItems(userId);</span><br><span class="line">    <span class="keyword">for</span> (Item item: items) &#123;</span><br><span class="line">        JSONObject obj = item.toJSONObject();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            obj.append(<span class="string">"favorite"</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        array.put(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    RpcHelper.writeJSONArray(response, array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="test-with-http-localhost-8080-Jupiter-history-user-id-1111"><a href="#test-with-http-localhost-8080-Jupiter-history-user-id-1111" class="headerlink" title="test with http://localhost:8080/Jupiter/history?user_id=1111"></a>test with <a href="http://localhost:8080/Jupiter/history?user_id=1111" target="_blank" rel="noopener">http://localhost:8080/Jupiter/history?user_id=1111</a></h2><h1 id="Recommendation-System"><a href="#Recommendation-System" class="headerlink" title="Recommendation System"></a>Recommendation System</h1><p>Widely exists in industry and it is a popular interview question. </p>
<p>Facebook: news feed, friends, ‘Do you know this friend?’的例子</p>
<p>LinkedIn: jobs, companies, acquaintances, ‘Are you interested in this job?’的例子</p>
<p>Amazon: 电饭锅的例子</p>
<p>Google Ads: 两颗红豆的例子</p>
<h2 id="Engineering-Design"><a href="#Engineering-Design" class="headerlink" title="Engineering Design"></a>Engineering Design</h2><ol>
<li><p>Given a user, fetch all the events (ids) this user has visited. (which table? which API?)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//history: history_id, user_id, item_id, last_favor_time.</span></span><br><span class="line">Set&lt;String&gt; itemIds = getFavoriteItemIds(userId);</span><br></pre></td></tr></table></figure>
</li>
<li><p>given all these events, what are the categories? (which table? which API?)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//categories: item_id, category.</span></span><br><span class="line">Set&lt;String&gt; categories = getCategories(itemId);</span><br></pre></td></tr></table></figure>
</li>
<li><p>given these categories, what are the events that belong to them (which table? which API?)</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//external API</span></span><br><span class="line">List&lt;Item&gt; items = searchItems(userId, lat, lon, category);</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>filter events that this user has visited</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/12.%20Simple%20Recommendation%20System-2019-4-17-11-58-6.png" alt="12. Simple Recommendation System-2019-4-17-11-58-6.png"></p>
<h2 id="Code-Implementation"><a href="#Code-Implementation" class="headerlink" title="Code Implementation"></a>Code Implementation</h2><h3 id="Add-a-new-package-src-algorithm-Add-GeoRecommendation-java"><a href="#Add-a-new-package-src-algorithm-Add-GeoRecommendation-java" class="headerlink" title="Add a new package src/algorithm. Add GeoRecommendation.java."></a>Add a new package <code>src/algorithm</code>. Add <code>GeoRecommendation.java</code>.</h3><blockquote>
<p>Idea of this algorithm: First get the current user’s favourite items, then get all categories of this user’s favorites, sort them by descending order. Then get these categories, search items again, sort this items with distance(Ascending order), and add those items to the result. Category &gt; Distance.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">recommendItems</span><span class="params">(String userId, <span class="keyword">double</span> lat, <span class="keyword">double</span> lon)</span> </span>&#123;</span><br><span class="line">    List&lt;Item&gt; recommendedItems = <span class="keyword">new</span> ArrayList&lt;Item&gt;();</span><br><span class="line">    DBConnection conn = DBConnectionFactory.getConnection();</span><br><span class="line">    <span class="comment">// 1. Get all favorite itemIds</span></span><br><span class="line">    Set&lt;String&gt; favoriteItemIds = conn.getFavoriteItemIds(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. Get all categories by favorite items, sort by count</span></span><br><span class="line">    <span class="comment">// Use a map to store category and its counts</span></span><br><span class="line">    Map&lt;String, Integer&gt; allCategories = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String itemId: favoriteItemIds) &#123;</span><br><span class="line">        Set&lt;String&gt; categories = conn.getCategories(itemId);</span><br><span class="line">        <span class="keyword">for</span> (String category: categories) &#123;</span><br><span class="line">            allCategories.put(category, allCategories.getOrDefault(category, <span class="number">0</span>) + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Sort the category</span></span><br><span class="line">    <span class="comment">// avoid integer overflow, Use Integer.compare(int, int)</span></span><br><span class="line">    List&lt;Entry&lt;String, Integer&gt;&gt; categoryList = <span class="keyword">new</span> ArrayList&lt;&gt;(allCategories.entrySet());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// more occurrences first</span></span><br><span class="line">    Collections.sort(categoryList, <span class="keyword">new</span> Comparator&lt;Entry&lt;String, Integer&gt;&gt;(</span><br><span class="line">            ) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Entry&lt;String, Integer&gt; o1, Entry&lt;String, Integer&gt; o2)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> Integer.compare(o2.getValue(), o1.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. do search based on category, filter out favorite events, sort by distance</span></span><br><span class="line">    </span><br><span class="line">    Set&lt;Item&gt; visitedItems = <span class="keyword">new</span> HashSet&lt;Item&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String ,Integer&gt; category: categoryList) &#123;</span><br><span class="line">        List&lt;Item&gt; items = conn.searchItems(lat, lon, category.getKey());</span><br><span class="line">        List&lt;Item&gt; filteredItems = <span class="keyword">new</span> ArrayList&lt;Item&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Item item: items) &#123;</span><br><span class="line">            <span class="comment">// if not visited again and not already in the favorite list, add to recommendation list</span></span><br><span class="line">            <span class="keyword">if</span> (!favoriteItemIds.contains(item.getItemId()) &amp;&amp; !visitedItems.contains(item)) &#123;</span><br><span class="line">                filteredItems.add(item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// sort the items in filtered items. less distance first</span></span><br><span class="line">        Collections.sort(filteredItems, <span class="keyword">new</span> Comparator&lt;Item&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Item o1, Item o2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Double.compare(o1.getDistance(), o2.getDistance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">        visitedItems.addAll(items);</span><br><span class="line">        recommendedItems.addAll(filteredItems);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> recommendedItems;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step-2-Go-to-src-rpc-RecommendItem-java-implement-doGet-method"><a href="#Step-2-Go-to-src-rpc-RecommendItem-java-implement-doGet-method" class="headerlink" title="Step 2, Go to src/rpc/RecommendItem.java, implement doGet()method."></a>Step 2, Go to <code>src/rpc/RecommendItem.java</code>, implement <code>doGet()</code>method.</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the lat and lon and current userId, return a list of recommended items</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    String userId = request.getParameter(<span class="string">"user_id"</span>);</span><br><span class="line">    <span class="keyword">double</span> lat = Double.parseDouble(request.getParameter(<span class="string">"lat"</span>));</span><br><span class="line">    <span class="keyword">double</span> lon = Double.parseDouble(request.getParameter(<span class="string">"lon"</span>));</span><br><span class="line">    </span><br><span class="line">    GeoRecommendation recommendation = <span class="keyword">new</span> GeoRecommendation();</span><br><span class="line">    List&lt;Item&gt; items = recommendation.recommendItems(userId, lat, lon);</span><br><span class="line">    </span><br><span class="line">    JSONArray result = <span class="keyword">new</span> JSONArray();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(Item item: items) &#123;</span><br><span class="line">            result.put(item.toJSONObject());				</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    RpcHelper.writeJSONArray(response, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Step-3-De-duplicate-items-in-recommendation-results"><a href="#Step-3-De-duplicate-items-in-recommendation-results" class="headerlink" title="Step 3, De-duplicate items in recommendation results."></a>Step 3, De-duplicate items in recommendation results.</h3><p>Since we’re using set to save results from our recommendation function, we need do the de-duplication based on <code>item_id</code>. So go to <code>Item.java</code>, add <code>hashCode()</code> and <code>equals()</code>. </p>
<p>Eclipse provides an easy way to add this two methods. Careful, only select <code>itemId</code> when generating these methods.</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/16/[Notes] JavaScript Basic 2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/16/[Notes] JavaScript Basic 2/" class="post-title-link" itemprop="url">[Notes] JavaScript Basic 2</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-16 23:51:09 / Modified: 16:51:57" itemprop="dateCreated datePublished" datetime="2019-04-16T23:51:09-07:00">2019-04-16</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">3.1k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">3 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Scope-chain"><a href="#Scope-chain" class="headerlink" title="Scope chain"></a>Scope chain</h1><p>In JavaScript there are two types of scope:</p>
<ul>
<li>Local scope</li>
<li>Global scope<br>JavaScript has function scope: Each function creates a new scope.</li>
</ul>
<p>Scope determines the accessibility (visibility) of these variables.</p>
<p>Variables defined inside a function are not accessible (visible) from outside the function.</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-14-55-3.png" alt="11. JavaScript Basic 2-2019-4-16-14-55-3.png"></p>
<h2 id="Scope-chain-1"><a href="#Scope-chain-1" class="headerlink" title="Scope chain"></a>Scope chain</h2><p>The scope chain property of each execution context is simply a collection of the current context variable object + all parent’s lexical variable objects.</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-14-55-8.png" alt="11. JavaScript Basic 2-2019-4-16-14-55-8.png"></p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-15-12-31.png" alt="11. JavaScript Basic 2-2019-4-16-15-12-31.png"></p>
<h1 id="this-in-JavaScript"><a href="#this-in-JavaScript" class="headerlink" title="this in JavaScript"></a>this in JavaScript</h1><p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-14-56-38.png" alt="11. JavaScript Basic 2-2019-4-16-14-56-38.png"></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.a = <span class="number">19</span>;</span><br><span class="line"><span class="comment">// window is a father object in JS</span></span><br><span class="line"><span class="comment">// 如果函数调用中没指定当前是类还是函数（是否有new），this默认指window</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'a'</span> <span class="keyword">in</span> <span class="built_in">window</span>);  <span class="comment">// return true</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h1><h2 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h2><p>A closure is a function having access to the parent scope, even after the parent function has closed.</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-15-34-31.png" alt="11. JavaScript Basic 2-2019-4-16-15-34-31.png"></p>
<blockquote>
<p>Closure here includes the annonymous function and the local variable arg. Here the local variable won’t be released even add() is ended.</p>
</blockquote>
<p>examples:<br><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-15-45-18.png" alt="11. JavaScript Basic 2-2019-4-16-15-45-18.png"></p>
<h1 id="BOM-amp-DOM"><a href="#BOM-amp-DOM" class="headerlink" title="BOM &amp; DOM"></a>BOM &amp; DOM</h1><h2 id="BOM"><a href="#BOM" class="headerlink" title="BOM"></a>BOM</h2><p>There are no official standards for the <code>Browser Object Model (BOM)</code>.<br>Since modern browsers have implemented (almost) the same methods and properties for JavaScript interactivity, it is often referred to, as methods and properties of the <code>BOM</code>.</p>
<p>The <code>BOM</code> (<code>Browser Object Model</code>) consists of the <code>objects navigator</code>, <code>history</code>,<code>screen</code>, <code>location</code> and <code>document</code> which are children of window</p>
<h2 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h2><p>The <code>Document Object Model (DOM)</code> connects web pages to scripts or programming languages. Usually that means <code>JavaScript</code>. The <code>DOM</code> model represents a document with a logical tree. <code>DOM</code> methods allow programmatic access to the tree; with them you can change the document’s structure, style or content. <code>DOM</code> nodes can have event handlers attached to them. Once an event is triggered, the event handlers get executed.</p>
<h3 id="Document-Object"><a href="#Document-Object" class="headerlink" title="Document Object"></a>Document Object</h3><ul>
<li>When an HTML document is loaded into a web browser, it becomes a document object.</li>
<li>The document object is the root node of the HTML document.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-15-58-16.png" alt="11. JavaScript Basic 2-2019-4-16-15-58-16.png"></p>
<h3 id="Finding-HTML-Elements"><a href="#Finding-HTML-Elements" class="headerlink" title="Finding HTML Elements"></a>Finding HTML Elements</h3><table>
<thead>
<tr>
<th style="text-align:center">Method</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">document.getElementById(id)</td>
<td style="text-align:center">Find an element by element id</td>
</tr>
<tr>
<td style="text-align:center">document.getElementsByTagName(name)</td>
<td style="text-align:center">Find elements by tag name</td>
</tr>
<tr>
<td style="text-align:center">document.getElementsByClassName(name)</td>
<td style="text-align:center">Find elements by class name</td>
</tr>
</tbody>
</table>
<h3 id="Changing-HTML-Elements"><a href="#Changing-HTML-Elements" class="headerlink" title="Changing HTML Elements"></a>Changing HTML Elements</h3><table>
<thead>
<tr>
<th style="text-align:center">Method</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">element.innerHTML =  new html content</td>
<td style="text-align:center">Change the inner HTML of an element</td>
</tr>
<tr>
<td style="text-align:center">element.attribute = new value</td>
<td style="text-align:center">Change the attribute value of an HTML element</td>
</tr>
<tr>
<td style="text-align:center">element.setAttribute(attribute, value)</td>
<td style="text-align:center">Change the attribute value of an HTML element</td>
</tr>
<tr>
<td style="text-align:center">element.style.property = new style</td>
<td style="text-align:center">Change the style of an HTML element</td>
</tr>
</tbody>
</table>
<h3 id="Adding-and-Deleting-Elements"><a href="#Adding-and-Deleting-Elements" class="headerlink" title="Adding and Deleting Elements"></a>Adding and Deleting Elements</h3><table>
<thead>
<tr>
<th style="text-align:center">Method</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">document.createElement(element)</td>
<td style="text-align:center">Create an HTML element</td>
</tr>
<tr>
<td style="text-align:center">document.removeChild(element)</td>
<td style="text-align:center">Remove an HTML element</td>
</tr>
<tr>
<td style="text-align:center">document.appendChild(element)</td>
<td style="text-align:center">Add an HTML element</td>
</tr>
<tr>
<td style="text-align:center">document.replaceChild(element)</td>
<td style="text-align:center">Replace an HTML element</td>
</tr>
<tr>
<td style="text-align:center">document.write(text)</td>
<td style="text-align:center">Write into the HTML output stream</td>
</tr>
</tbody>
</table>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-16-6-14.png" alt="11. JavaScript Basic 2-2019-4-16-16-6-14.png"></p>
<h1 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h1><ol>
<li><code>Capturing phase</code> – the event goes down to the element.</li>
<li><code>Bubbling phase</code> – the event bubbles up from the element.<br><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-16-7-19.png" alt="11. JavaScript Basic 2-2019-4-16-16-7-19.png"></li>
</ol>
<h2 id="DOM0-onclick"><a href="#DOM0-onclick" class="headerlink" title="DOM0 - onclick"></a>DOM0 - onclick</h2><p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-16-20-12.png" alt="11. JavaScript Basic 2-2019-4-16-16-20-12.png"></p>
<blockquote>
<p>Don’t write JS code inline.</p>
</blockquote>
<h2 id="DOM2-addEventListener"><a href="#DOM2-addEventListener" class="headerlink" title="DOM2 - addEventListener"></a>DOM2 - addEventListener</h2><p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-16-31-8.png" alt="11. JavaScript Basic 2-2019-4-16-16-31-8.png"></p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-16-31-24.png" alt="11. JavaScript Basic 2-2019-4-16-16-31-24.png"></p>
<blockquote>
<p> 捕获阶段与冒泡阶段区别在于谁先触发</p>
</blockquote>
<p>Example:</p>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/11.%20JavaScript%20Basic%202-2019-4-16-16-40-14.png" alt="11. JavaScript Basic 2-2019-4-16-16-40-14.png"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/16/[Notes] MySQL Basic 2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/16/[Notes] MySQL Basic 2/" class="post-title-link" itemprop="url">[Notes] MySQL Basic 2</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-16 21:27:17 / Modified: 14:29:55" itemprop="dateCreated datePublished" datetime="2019-04-16T21:27:17-07:00">2019-04-16</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">9.1k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">8 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Save-search-results-to-database"><a href="#Save-search-results-to-database" class="headerlink" title="Save search results to database"></a>Save search results to database</h1><ol>
<li>Under <code>db.mysql</code> package, create class/<code>MySQLConnection.java</code>. </li>
<li>Implement <code>DBConnection</code> interface</li>
<li>Implement both <code>close</code> method and <code>constructor</code>.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connection</span></span><br><span class="line"><span class="keyword">private</span> Connection conn;</span><br><span class="line"></span><br><span class="line"><span class="comment">// constructor</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MySQLConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>).newInstance();</span><br><span class="line">        conn = DriverManager.getConnection(MySQLDBUtil.URL);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * close the connection</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            conn.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>implement <code>searchItems()</code> in <code>MySQLConnection</code>. Previously we call <code>TicketMasterAPI.search</code> from our <code>SearchItem</code> servlet directly. But actually our recommendation code also needs to call the same search function, so we make a designated function here to do the search call.<br>The code is simply copied from what we’ve already had in <code>SearchItem.java</code>.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Search Item. Same as TMAPI search item.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Item&gt; <span class="title">searchItems</span><span class="params">(<span class="keyword">double</span> lat, <span class="keyword">double</span> lon, String term)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Get the items from TM</span></span><br><span class="line">    TicketMasterAPI tmAPI = <span class="keyword">new</span> TicketMasterAPI();</span><br><span class="line">    List&lt;Item&gt; items = tmAPI.search(lat, lon, term);</span><br><span class="line">    <span class="comment">// Save the items to the db</span></span><br><span class="line">    <span class="keyword">for</span> (Item item: items) &#123;</span><br><span class="line">        saveItem(item);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> items;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>after <code>searchItem</code>, let’s try <code>saveItem</code> to save data into database. Again, careful with the import suggestions. Always choose <code>java.sql.*</code>.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Save single item into db</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveItem</span><span class="params">(Item item)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"INSERT IGNORE INTO items VALUES (?, ?, ?, ?, ?, ?, ?)"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        <span class="comment">// Index starts from 1</span></span><br><span class="line">        stmt.setString(<span class="number">1</span>, item.getItemId());</span><br><span class="line">        stmt.setString(<span class="number">2</span>, item.getName());</span><br><span class="line">        stmt.setDouble(<span class="number">3</span>, item.getRating());</span><br><span class="line">        stmt.setString(<span class="number">4</span>, item.getAddress());</span><br><span class="line">        stmt.setString(<span class="number">5</span>, item.getImageURL());</span><br><span class="line">        stmt.setString(<span class="number">6</span>, item.getUrl());</span><br><span class="line">        stmt.setDouble(<span class="number">7</span>,  item.getDistance());</span><br><span class="line">        stmt.execute();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// set categories</span></span><br><span class="line">        sql = <span class="string">"INSERT IGNORE INTO categories VALUES(?, ?)"</span>;</span><br><span class="line">        stmt = conn.prepareStatement(sql);</span><br><span class="line">        <span class="keyword">for</span> (String category: item.getCategories()) &#123;</span><br><span class="line">            stmt.setString(<span class="number">1</span>, item.getItemId());</span><br><span class="line">            stmt.setString(<span class="number">2</span>, category);</span><br><span class="line">            stmt.execute();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Use PreparedStatement and stmt.settring() can effectively avoid SQL injection.</p>
</blockquote>
<blockquote>
<p>PreparedStatement is faster than raw String. Only have to create it once.</p>
</blockquote>
<ol start="6">
<li>SQL injection. Turns the input to the SQL statement, and makes the query always true.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SQL injection</span></span><br><span class="line"><span class="comment">// Example:</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE username = '&lt;username&gt;' AND password = '&lt;password&gt;';</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// sql = "SELECT * FROM users WHERE username = '" + username + "'</span></span><br><span class="line"><span class="comment">//       AND password = '" + password + "'"</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// username: aoweifjoawefijwaoeifj</span></span><br><span class="line"><span class="comment">// password: 123456' OR '1' = '1</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// SELECT * FROM users WHERE username = 'aoweifjoawefijwaoeifj' AND password = '123456' OR '1' = '1'</span></span><br></pre></td></tr></table></figure>
<ol start="7">
<li>update <code>DBConnectionFactory</code>.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DBConnection <span class="title">getConnection</span><span class="params">(String db)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (db) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"mysql"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MySQLConnection();</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"mongodb"</span>:</span><br><span class="line">        <span class="comment">// return new MongoDBConnection();</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid db: "</span> + db);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="8">
<li>In <code>src/rpc/SearchItem.java</code>, add a private <code>dbconnection</code> field and update <code>doGet()</code>.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">double</span> lat = Double.parseDouble(request.getParameter(<span class="string">"lat"</span>));</span><br><span class="line">    <span class="keyword">double</span> lon = Double.parseDouble(request.getParameter(<span class="string">"lon"</span>));</span><br><span class="line">    </span><br><span class="line">    String keyword = request.getParameter(<span class="string">"term"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Connect db first then search</span></span><br><span class="line">    DBConnection conn = DBConnectionFactory.getConnection();</span><br><span class="line">    List&lt;Item&gt; items = conn.searchItems(lat, lon, keyword);</span><br><span class="line">    </span><br><span class="line">    JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Item item : items) &#123;</span><br><span class="line">            JSONObject obj = item.toJSONObject();</span><br><span class="line">            array.put(obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    RpcHelper.writeJSONArray(response, array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Implement-set-unset-favorite-related-functions"><a href="#Implement-set-unset-favorite-related-functions" class="headerlink" title="Implement set/unset favorite related functions"></a>Implement set/unset favorite related functions</h1><ol>
<li>let’s try setFavoriteItem and unsetFavoriteItem</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Operate on History table.</span></span><br><span class="line"><span class="comment">    * insert favorite information.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFavoriteItems</span><span class="params">(String userId, List&lt;String&gt; itemIds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"INSERT IGNORE INTO history (?, ?)"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        <span class="keyword">for</span> (String itemId: itemIds) &#123;</span><br><span class="line">            stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">            stmt.setString(<span class="number">2</span>, itemId);</span><br><span class="line">            stmt.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Delete favorite information</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unsetFavoriteItems</span><span class="params">(String userId, List&lt;String&gt; itemIds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"DELETE FROM history WHERE user_id = ? AND item_id = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        <span class="keyword">for</span> (String itemId: itemIds) &#123;</span><br><span class="line">            stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">            stmt.setString(<span class="number">2</span>, itemId);</span><br><span class="line">            stmt.execute();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>create a new servlet called <code>ItemHistory</code>, update the url mapping to <code>\history</code></p>
</li>
<li><p>create a new function in RpcHelper.java  to parse HTTP request body. Imagine the input HTTP request looks like:</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    user_id = “<span class="number">1111</span>”,</span><br><span class="line">    favorite = [</span><br><span class="line">        “abcd”,</span><br><span class="line">        “efgh”,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Read the http request and parse it as a JSONObject.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title">readJsonObject</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        BufferedReader reader = request.getReader();</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sb.append(line);</span><br><span class="line">        &#125;</span><br><span class="line">        reader.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JSONObject(sb.toString());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>update <code>doPost()</code> and <code>doDelete</code> in <code>ItemHistory.java</code> to use this new function. </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the set favourite request and do the corresponding operation</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// get userId, itemIDs from request</span></span><br><span class="line">        JSONObject input = RpcHelper.readJsonObject(request);</span><br><span class="line">        String userId = input.getString(<span class="string">"user_id"</span>);</span><br><span class="line">        JSONArray fav_array = input.getJSONArray(<span class="string">"favorite"</span>);</span><br><span class="line">        List&lt;String&gt; itemIds = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fav_array.length(); i++) &#123;</span><br><span class="line">            itemIds.add(fav_array.get(i).toString());</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// connect db and update the table</span></span><br><span class="line">        DBConnection conn = DBConnectionFactory.getConnection();</span><br><span class="line">        conn.setFavoriteItems(userId, itemIds);</span><br><span class="line">        conn.close();</span><br><span class="line">        RpcHelper.writeJSONObject(response, <span class="keyword">new</span> JSONObject().put(<span class="string">"result"</span>, <span class="string">"SUCCESS"</span>));</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Same as doPost(), but change setFavoriteItems() to unsetFavoriteItems()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDelete</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>open postman, switch to <code>post</code> method, use <a href="http://localhost:8080/Jupiter/history" target="_blank" rel="noopener">http://localhost:8080/Jupiter/history</a>, then copy the following JSON object into body. Replace <code>item_id1</code> and <code>item_id2</code> with the real <code>item_id</code> exist in your item table.</li>
</ol>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     'user_id':'1111',</span><br><span class="line">     'favorite' : [</span><br><span class="line">         'item_id1',</span><br><span class="line">         'item_id2'</span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>now let’s send another request to test our delete function. Open another tab in postman, switch method to <code>delete</code>, use <a href="http://localhost:8080/Jupiter/history" target="_blank" rel="noopener">http://localhost:8080/Jupiter/history</a>, then copy the following JSON object into body. Again replace <code>item_id1</code> with the real <code>item_id</code> exist in your history table.<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     'user_id':'1111',</span><br><span class="line">     'favorite' : [</span><br><span class="line">         'item_id1',</span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/14/[Notes] JavaScript Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Anda Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anda">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/14/[Notes] JavaScript Basic/" class="post-title-link" itemprop="url">[Notes] JavaScript Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-14 17:39:28 / Modified: 10:52:19" itemprop="dateCreated datePublished" datetime="2019-04-14T17:39:28-07:00">2019-04-14</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">8.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">7 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Linking-JavaScript-file-and-html-file"><a href="#Linking-JavaScript-file-and-html-file" class="headerlink" title="Linking JavaScript file and html file"></a>Linking JavaScript file and html file</h1><h2 id="Adding-JavaScript-into-an-HTML-Document"><a href="#Adding-JavaScript-into-an-HTML-Document" class="headerlink" title="Adding JavaScript into an HTML Document"></a>Adding JavaScript into an HTML Document</h2><p>You can add JavaScript code in an HTML document by employing the dedicated HTML tag<code>&lt;script&gt;</code> that wraps around JavaScript code.<br>The <code>&lt;script&gt;</code> tag can be placed in the <code>&lt;head&gt;</code> section of your HTML, in the <code>&lt;body&gt;</code> section, or after the <code>&lt;/body&gt;</code> close tag, depending on when you want the JavaScript to load.</p>
<h3 id="Method-1-Inline-Mode"><a href="#Method-1-Inline-Mode" class="headerlink" title="Method 1: Inline Mode"></a>Method 1: Inline Mode</h3><p><img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-13-18-32-30.png" alt="9. JavaScript Basic-2019-4-13-18-32-30.png"></p>
<blockquote>
<p>不便于代码分离</p>
</blockquote>
<h3 id="Method-2-using-lt-script-gt-tag"><a href="#Method-2-using-lt-script-gt-tag" class="headerlink" title="Method 2: using &lt;script&gt; tag"></a>Method 2: using <code>&lt;script&gt;</code> tag</h3><p>The <code>&lt;script&gt;</code> tag can be placed in the <code>&lt;head&gt;</code> section of your HTML, in the <code>&lt;body&gt;</code> section, or after the <code>&lt;/body&gt;</code> close tag, depending on when you want the JavaScript to load.</p>
<ul>
<li>Internal Style</li>
<li>External Style</li>
<li><img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-13-18-38-21.png" alt="9. JavaScript Basic-2019-4-13-18-38-21.png"></li>
</ul>
<blockquote>
<p>浏览器先执行完<code>&lt;script&gt;</code>tag才会渲染其他组件</p>
</blockquote>
<h1 id="JavaScript-Fundamentals"><a href="#JavaScript-Fundamentals" class="headerlink" title="JavaScript Fundamentals"></a>JavaScript Fundamentals</h1><h2 id="variables"><a href="#variables" class="headerlink" title="variables"></a>variables</h2><ul>
<li>three ways of variable declaration:<ul>
<li>let</li>
<li>var</li>
<li>const</li>
</ul>
</li>
</ul>
<p>We use those three keywords to create variables in JavaScript. Example: <code>let message; or var message; or const message;</code></p>
<ol>
<li>var variables are defined from the beginning of the function, no matter where the definition is.</li>
<li>var has no block scope.</li>
<li>var can be declared many times, but let and const cannot in the same scope.</li>
<li>const is used to declare a constant (unchanging) variable(immutable)</li>
<li>let has only block scope, while var can be global</li>
</ol>
<h2 id="Data-Types"><a href="#Data-Types" class="headerlink" title="Data Types"></a>Data Types</h2><p>JavaScript is “dynamically typed”, meaning that there are data types, but variables are not bound to any of them.</p>
<h3 id="Date-types-Number-String-Boolean-Object-Function-Null-Undefined"><a href="#Date-types-Number-String-Boolean-Object-Function-Null-Undefined" class="headerlink" title="Date types: Number, String, Boolean, Object, Function, Null, Undefined"></a>Date types: <code>Number</code>, <code>String</code>, <code>Boolean</code>, <code>Object</code>, <code>Function</code>, <code>Null</code>, <code>Undefined</code></h3><ul>
<li><p><code>Number</code> - The number type serves both for integer and floating point numbers: 123, 12.22..</p>
<p>Note: <code>NaN</code> belong to the type number but it’s not “normal” numbers. <code>NaN</code> represents an error.</p>
</li>
<li><p><code>String</code> - A string may consist of only one character or many of them. Double and single quotes have no difference between them in JavaScript. E.g. ‘aba’, “I am a string.”</p>
</li>
<li><p><code>Boolean</code> - The boolean type has only two values: true and false.</p>
</li>
<li><p><code>Null</code> - <strong>A special value</strong> which is for unknown values. </p>
<p>In JavaScript null is not a “reference to a non-existing object” or a “null pointer” like in some other languages.<br>It’s just a special value which has the sense of “nothing”, “empty” or “value unknown”.</p>
<p>Example: <code>var age = null;</code><br>The code above states that the age is unknown or empty for some reason.</p>
</li>
<li><p><code>Undefined</code> - A special value which is for unassigned values. The meaning of undefined is “value is not assigned”.     </p>
</li>
</ul>
<blockquote>
<p>Undefined 和 null 不是数据类型，而是特殊值</p>
</blockquote>
<ul>
<li>Function and Object will cover on the following section.</li>
</ul>
<h3 id="typeof-Operator"><a href="#typeof-Operator" class="headerlink" title="typeof Operator"></a><code>typeof</code> Operator</h3><p>  returns the type of the argument. It’s useful when we want to process values of different types differently, or just want to make a quick check.<br>    e.g. <code>typeof “abc” - string</code></p>
<h3 id="Comparisons"><a href="#Comparisons" class="headerlink" title="Comparisons"></a>Comparisons</h3><p>A comparison returns a value. The value is of the boolean type: true or false.</p>
<ul>
<li>Greater/less than: <code>a &gt; b</code>, <code>a &lt; b</code>.</li>
<li>Greater/less than or equals: <code>a &gt;= b</code>, <code>a &lt;= b</code>.</li>
<li>Equality check is written as <code>a == b</code> (please note the double equation sign <code>=</code>. A single symbol <code>a = b</code> would mean an assignment).</li>
<li>Not equals. In maths the notation is <code>≠</code>, in JavaScript it’s written as an assignment with an exclamation sign before it: <code>a != b</code>.</li>
</ul>
<p>Note:<br>A regular equality check <code>==</code> has a problem. It cannot differ 0 from false:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> == <span class="literal">false</span>  <span class="comment">// true</span></span><br><span class="line">“” == <span class="literal">false</span> <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p>That’s because operands of different types are converted to a number by the equality operator <code>==</code>. An empty string, just like false, becomes a zero.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Number</span>(<span class="literal">false</span>) =&gt; <span class="number">0</span>, <span class="built_in">Number</span>(“”) =&gt; <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<p>What to do if we’d like to differentiate 0 from false?</p>
<p>A strict equality operator <code>===</code> checks the equality without type conversion.<br>In other words, if a and b are of different types, then <code>a===b</code> immediately returns <code>false</code> without an attempt to convert them.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> === <span class="literal">false</span> <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<h2 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h2><p>Functions are the main “building blocks” of the program. They allow the code to be called many times without repetition.</p>
<ol>
<li>Function Declaration<br><img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-14-9-38-10.png" alt="9. JavaScript Basic-2019-4-14-9-38-10.png"></li>
</ol>
<p>The function keyword goes first, then goes the name of the function, then a list of parameters between the parentheses (empty in the example above) and finally the code of the function, also named “the function body”, between curly braces.</p>
<ol start="2">
<li>Function Expression<br><img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-14-9-42-42.png" alt="9. JavaScript Basic-2019-4-14-9-42-42.png"></li>
</ol>
<p>The meaning of these code samples is the same: “create a function and put it into the variable sayHi”.</p>
<h2 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h2><ol>
<li>Objects are used to store keyed collections of various data and more complex entities. </li>
</ol>
<p>e.g. Dog object: age, name, color, breed attributes, and run() activity.</p>
<ol start="2">
<li><p>How to create an instance of object</p>
<ol>
<li><p>using new keyword </p>
<p>E.g. </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> car = <span class="keyword">new</span> Car();</span><br><span class="line">  car.color = “red”;</span><br><span class="line">  car.type = “suv”;</span><br></pre></td></tr></table></figure>
</li>
<li><p>using literal {} 字面量<br>E.g. <code>var car = { color: ‘red’, type: ‘suv’};</code></p>
</li>
</ol>
</li>
<li><p>Use <code>.</code> or <code>[]</code> to visit attributes. </p>
<p> eg </p>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t2.name; </span><br><span class="line">t2[<span class="string">'age'</span>]; </span><br><span class="line">t2[<span class="string">'run'</span>](); <span class="comment">// function call</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>example<br> <img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-14-9-49-37.png" alt="9. JavaScript Basic-2019-4-14-9-49-37.png"></p>
</li>
</ol>
<h2 id="Primitive-Type-VS-Reference-Type"><a href="#Primitive-Type-VS-Reference-Type" class="headerlink" title="Primitive Type VS. Reference Type"></a>Primitive Type VS. Reference Type</h2><ol>
<li>Numbers, Strings, Booleans, and the null and undefined types are primitive. </li>
<li>Objects, and functions are reference types.</li>
</ol>
<p>Difference: </p>
<ol>
<li><p>A primitive type has a fixed size in memory. For example, a number occupies eight bytes of memory, and a boolean value can be represented with only one bit. A reference type does not have a fixed size in memory.</p>
</li>
<li><p>Primitive types are assigned/copied “as a whole value”, but reference types are stored and copied “by reference”.</p>
</li>
</ol>
<ul>
<li><p>A variable stores not the object itself, but its “address in memory”, in other words “a reference” to it.</p>
</li>
<li><p>When an object variable is copied.the reference is copied, the object is not duplicated. </p>
</li>
</ul>
<h2 id="Pass-by-reference-and-pass-by-value"><a href="#Pass-by-reference-and-pass-by-value" class="headerlink" title="Pass by reference and pass by value"></a>Pass by reference and pass by value</h2><ol>
<li>In JavaScript primitive types are copied and passed by value and objects are copied and passed by <strong>reference</strong> value.</li>
</ol>
<p><img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-14-10-5-3.png" alt="9. JavaScript Basic-2019-4-14-10-5-3.png"></p>
<ol start="2">
<li><p>In terms of function:</p>
<ol>
<li><p>In Pass by Value, function is called by directly passing the value of the variable as the argument. Changing the argument inside the function doesn’t affect the variable passed from outside the function.</p>
</li>
<li><p>In Pass by Reference, function is called by directly passing the reference/address of the variable as the argument. Changing the argument inside the function affect the variable passed from outside the function. </p>
</li>
<li><p>example<br><img src="https://raw.githubusercontent.com/Luorinz/images/master/9.%20JavaScript%20Basic-2019-4-14-10-10-25.png" alt="9. JavaScript Basic-2019-4-14-10-10-25.png"></p>
</li>
</ol>
</li>
</ol>
<p>##<br> Hoisting 变量提升</p>
<p>Hoisting is a JavaScript mechanism where variables and function declarations are moved to the top of their scope before code execution.</p>
<ol>
<li><p>Execution Context</p>
<ul>
<li>Global execution context (GEC): This is the default execution context in which JS code start it’s execution when the file first loads in the browser. </li>
<li>Functional execution context (FEC): Functional execution context is defined as the context created by the execution of code inside a function. Each function has its own execution context. </li>
</ul>
</li>
<li><p>Execution context stack </p>
<ul>
<li>Execution context stack is a stack data structure to store all the execution stacks created while executing the JS code. </li>
<li>Global execution context is present by default in execution context stack and it is at the bottom of the stack.</li>
<li>While executing global execution context code, if JS engines finds a function call, it creates functional execution context of that function and pushes that function execution context on top of execution context stack. </li>
<li>JS engine executes the function whose execution context is at the top of the execution context stack.</li>
<li>Once all the code of the function is executed, JS engines pop’s out that function’s execution context and start’s executing the function which is below it.</li>
</ul>
</li>
<li><p>JavaScript engine creates the execution context in the following two stages: <code>Creation phase</code> and <code>Execution phase</code>.</p>
</li>
</ol>
<ul>
<li><p>In creation phase, JS engine performs the following task:</p>
<ul>
<li>creates the <code>activation object</code> or the <code>variable object</code>: <code>activation object</code> is a special object in JS which contain all the variables, function arguments and inner functions declarations information. </li>
<li>creates the <code>scope chain</code>: Once the <code>activation object</code> gets created, JS engine initializes the scope chain which is a list of all the <code>variables objects</code> inside which the current function exists. This also includes the <code>variable object</code> of <code>global execution context</code>. Scope chain also contains the current <code>function variable object</code>.</li>
<li>determines the value of <code>this</code>: After the <code>scope chain</code>, JavaScript engine initialize the value of <code>‘this’</code>.</li>
</ul>
</li>
<li><p>In the execution phase, JS engines will again scan through the function to update the variable object with the values of the variables and will execute the code.</p>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Anda Luo</p>
              <div class="site-description motion-element" itemprop="description">Notes of study, work and life</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/Luorinz" title="GitHub &rarr; https://github.com/Luorinz" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:luorinz@gmail.com" title="E-Mail &rarr; mailto:luorinz@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  
    <div id="sidebar-dimmer"></div>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Anda Luo</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">142k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="Reading time total">2:09</span>
  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  



  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>











  



  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  
  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script>
  
    bookmark.loadBookmark();
  
  </script>


  

  

  

</body>
</html>
